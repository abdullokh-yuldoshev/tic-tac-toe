<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Анти-кэш -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Tic-Tac-Toe+</title>

  <style>
    :root{
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);

      --rXL: 26px;
      --rLG: 18px;
      --rMD: 14px;

      --shadow1: 0 18px 40px rgba(0,0,0,.12);
      --shadow2: 0 10px 24px rgba(0,0,0,.10);

      --teal1:#22c1ba;
      --teal2:#1aa8a2;

      --text:#0e1b1a;
      --muted: rgba(14,27,26,.62);
      --card: rgba(255,255,255,.90);
      --stroke: rgba(14,27,26,.12);

      --bg1:#eaf6f6;
      --bg2:#f4fbfb;

      --btnBg: rgba(255,255,255,.55);
      --btnText: rgba(14,27,26,.92);

      --last: rgba(34,193,186,.12);
      --win: rgba(34,193,186,.22);
    }

    [data-theme="dark"]{
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --card: rgba(15,28,30,.86);
      --stroke: rgba(255,255,255,.12);

      --bg1:#071214;
      --bg2:#0a1b1d;

      --btnBg: rgba(0,0,0,.22);
      --btnText: rgba(255,255,255,.92);

      --shadow1: 0 18px 40px rgba(0,0,0,.45);
      --shadow2: 0 10px 24px rgba(0,0,0,.38);

      --last: rgba(255,255,255,.08);
      --win: rgba(34,193,186,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      overflow:hidden;
      background:
        radial-gradient(1100px 650px at 15% 0%, rgba(34,193,186,.20) 0%, rgba(34,193,186,0) 55%),
        radial-gradient(900px 560px at 85% 20%, rgba(34,193,186,.16) 0%, rgba(34,193,186,0) 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    /* Важно для WebView/Telegram: */
    button, .chip, .tab, .cell{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app{
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--safeTop) + 18px) 16px calc(var(--safeBottom) + 18px);
    }

    .stage{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
      z-index: 1; /* чтоб точно было выше фона */
    }

    .center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      width:100%;
    }

    .hero{
      width:100%;
      border-radius: var(--rXL);
      background: linear-gradient(135deg, var(--teal1) 0%, var(--teal2) 100%);
      box-shadow: var(--shadow1);
      padding: 18px;
      position:relative;
      overflow:hidden;
    }
    /* Декор НЕ должен ловить клики */
    .hero::after{
      content:"";
      position:absolute;
      right:-60px;
      top:-40px;
      width:180px;
      height:180px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      pointer-events:none;
    }

    .heroKicker{font-size:13px; color:rgba(255,255,255,.90); font-weight:700;}
    .heroTitle{margin:6px 0 0; font-size:34px; line-height:1.05; color:rgba(255,255,255,.96); font-weight:900;}
    .heroMeta{margin-top:10px; color:rgba(255,255,255,.92); font-size:14px; font-weight:700; line-height:1.35;}
    .heroActions{margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;}

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding: 12px 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:900;
      font-size:15px;
      user-select:none;
      transition: transform .06s ease, opacity .12s ease;
      position:relative;
      z-index: 2; /* чтоб точно кликабельны */
    }
    .btn:active{transform:scale(.98)}
    .btnPrimary{
      background: rgba(255,255,255,.22);
      color: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(10px);
    }
    .btnDisabled{opacity:.45; cursor:not-allowed;}

    .panel{
      width:100%;
      border-radius: var(--rXL);
      background: var(--card);
      box-shadow: var(--shadow2);
      border: 1px solid var(--stroke);
      padding: 16px;
      position:relative;
      z-index:2;
    }

    .panelHeader{display:flex; justify-content:space-between; gap:12px; align-items:baseline; margin-bottom:10px;}
    .panelTitle{margin:0; font-size:26px; font-weight:950;}
    .panelHint{font-size:13px; color:var(--muted); font-weight:700;}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media(max-width:420px){ .grid2{grid-template-columns:1fr;} .heroTitle{font-size:30px;} }

    .field{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .label{font-size:13px; color:var(--muted); font-weight:800;}

    select,input{
      width:100%;
      padding: 12px;
      font-size:16px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      color: var(--text);
      outline:none;
    }
    [data-theme="dark"] select, [data-theme="dark"] input{
      background: rgba(0,0,0,.22);
      color: var(--text);
    }

    .chips{display:flex; flex-wrap:wrap; gap:10px;}
    .chip{
      padding: 11px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:3;
    }
    [data-theme="dark"] .chip{background: rgba(0,0,0,.18);}
    .chip:active{transform:scale(.98)}
    .chipOn{
      border-color: rgba(34,193,186,.55);
      background: rgba(34,193,186,.10);
      box-shadow: 0 0 0 3px rgba(34,193,186,.10) inset;
    }

    .saveRow{margin-top:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .btnSave{
      background: linear-gradient(180deg, rgba(34,193,186,1) 0%, rgba(26,168,162,1) 100%);
      color: rgba(255,255,255,.96);
      border:none;
      padding: 13px 18px;
      font-size:16px;
      font-weight:950;
    }
    .mini{font-size:12px; color:var(--muted); font-weight:800;}

    .tabbar{
      width:100%;
      border-radius:999px;
      padding: 10px;
      background: rgba(15,28,30,.10);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      display:flex;
      gap:10px;
      position:relative;
      z-index:2;
    }
    [data-theme="dark"] .tabbar{background: rgba(0,0,0,.25);}

    .tab{
      flex:1;
      border:none;
      background: transparent;
      border-radius:999px;
      padding: 12px 14px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      color: var(--btnText);
      position:relative;
      z-index:3;
    }
    .tab:active{transform:scale(.985)}
    .tabOn{
      background: rgba(34,193,186,.14);
      border: 1px solid rgba(34,193,186,.35);
    }

    /* GAME */
    .gameWrap{width:100%; display:flex; flex-direction:column; gap:12px;}
    .gameTop{
      width:100%;
      border-radius: var(--rXL);
      background: var(--card);
      box-shadow: var(--shadow2);
      border: 1px solid var(--stroke);
      padding: 14px;
      position:relative;
      z-index:2;
    }
    .topRow{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .turnTitle{margin:0; font-size:22px; font-weight:950;}
    .subLine{margin-top:4px; font-size:14px; color:var(--muted); font-weight:800;}
    .exitBtn{
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--btnBg);
      color: var(--btnText);
      font-weight:950;
      padding: 10px 14px;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:3;
    }
    .exitBtn:active{transform:scale(.98)}

    .goalRow{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .goalSelect{flex:1; min-width: 220px;}
    .statusPill{
      margin-left:auto;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--btnBg);
      padding: 10px 12px;
      font-weight:950;
      color: var(--btnText);
      user-select:none;
      position:relative;
      z-index:2;
    }

    .controlRow{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
    .ctrlBtn{
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--btnBg);
      color: var(--btnText);
      font-weight:950;
      padding: 10px 14px;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:3;
    }
    .ctrlBtn:active{transform:scale(.98)}
    .ctrlBtn[disabled]{opacity:.45; cursor:not-allowed;}

    .boardCard{
      width:100%;
      border-radius: var(--rXL);
      background: var(--card);
      box-shadow: var(--shadow2);
      border: 1px solid var(--stroke);
      padding: 14px;
      position:relative;
      z-index:2;
    }
    .board{
      width:100%;
      aspect-ratio:1/1;
      display:grid;
      gap:8px;
      padding:10px;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.02);
    }
    [data-theme="dark"] .board{background: rgba(255,255,255,.04);}

    .cell{
      border-radius: 16px;
      border: 1px solid rgba(14,27,26,.10);
      background: rgba(255,255,255,.62);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-size: clamp(16px, 3vw, 26px);
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:1;
    }
    [data-theme="dark"] .cell{
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.10);
    }
    .cell:active{transform:scale(.98)}
    .cellDisabled{cursor:not-allowed; opacity:.9;}
    .cellLast{background: var(--last); border-color: rgba(34,193,186,.40);}
    .cellWin{background: var(--win); border-color: rgba(34,193,186,.55);}

    .hidden{display:none !important;}

    /* MODAL: когда скрыта — не перехватывает клики */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modalBack.on{display:flex;}
    .modal{
      width:min(420px, 100%);
      border-radius: 22px;
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow1);
      padding: 14px;
    }
    .modalTitle{margin:0; font-size:18px; font-weight:950;}
    .modalText{margin:8px 0 12px; color:var(--muted); font-size:14px; font-weight:700; line-height:1.35;}
    .modalBtns{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
    .btnPlain{
      background: var(--btnBg);
      color: var(--btnText);
      border: 1px solid var(--stroke);
      font-weight:950;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">

      <!-- HOME -->
      <div id="screenHome" class="center">
        <div class="hero">
          <div class="heroKicker" id="homeKicker">Главная</div>
          <div class="heroTitle" id="homeTitle">Tic-Tac-Toe+</div>
          <div class="heroMeta" id="homeMeta"></div>
          <div class="heroActions">
            <button id="btnStart" class="btn btnPrimary" type="button">
              <span>▶</span><span id="btnStartText">Начать игру</span>
            </button>
          </div>
        </div>

        <div class="tabbar">
          <button id="tabHome" class="tab tabOn" type="button">⌂ <span id="tabHomeText">Главная</span></button>
          <button id="tabSettings" class="tab" type="button">⚙ <span id="tabSettingsText">Настройки</span></button>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="screenSettings" class="center hidden">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle" id="settingsTitle">Настройки</div>
            <div class="panelHint" id="settingsHint">Сохрани — и нажми “Начать игру”</div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label" id="lblLang">Язык</div>
              <select id="selLang">
                <option value="ru">Русский</option>
                <option value="en">English</option>
                <option value="uz">O‘zbek (lotin)</option>
              </select>
            </div>
            <div class="field">
              <div class="label" id="lblTheme">Тема</div>
              <select id="selTheme">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div class="label" id="lblMode">Режим</div>
            <div class="chips" id="modeChips"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label" id="lblSize">Размер поля</div>
              <select id="selSize"></select>
            </div>
            <div class="field">
              <div class="label" id="lblGoal">Цель (в ряд)</div>
              <select id="selGoal"></select>
            </div>
          </div>

          <div class="grid2" id="aiRow">
            <div class="field">
              <div class="label" id="lblAI">Сложность ИИ</div>
              <select id="selAI">
                <option value="easy">Лёгкая</option>
                <option value="normal">Нормальная</option>
                <option value="hard">Сложная</option>
                <option value="expert">Эксперт</option>
              </select>
            </div>
            <div class="field">
              <div class="label">Подсказка</div>
              <input type="text" readonly value="Для больших полей ИИ — эвристика (без лагов)" />
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label" id="lblP1">Игрок 1 (X)</div>
              <input id="inpP1" maxlength="16" placeholder="Alex" />
            </div>
            <div class="field">
              <div class="label" id="lblP2">Игрок 2 (O)</div>
              <input id="inpP2" maxlength="16" placeholder="Player 2" />
            </div>
          </div>

          <div class="grid2" id="nameGrid34" style="display:none;">
            <div class="field">
              <div class="label" id="lblP3">Игрок 3 (△)</div>
              <input id="inpP3" maxlength="16" placeholder="Player 3" />
            </div>
            <div class="field">
              <div class="label" id="lblP4">Игрок 4 (□)</div>
              <input id="inpP4" maxlength="16" placeholder="Player 4" />
            </div>
          </div>

          <div class="saveRow">
            <button id="btnSave" class="btn btnSave" type="button"><span id="btnSaveText">Сохранить</span></button>
            <div class="mini" id="buildText"></div>
          </div>
        </div>

        <div class="tabbar">
          <button id="tabHome2" class="tab" type="button">⌂ <span id="tabHomeText2">Главная</span></button>
          <button id="tabSettings2" class="tab tabOn" type="button">⚙ <span id="tabSettingsText2">Настройки</span></button>
        </div>
      </div>

      <!-- GAME -->
      <div id="screenGame" class="hidden">
        <div class="gameWrap">
          <div class="gameTop">
            <div class="topRow">
              <div>
                <div class="turnTitle" id="turnTitle">Ходит: Alex (X)</div>
                <div class="subLine" id="turnSub">8×8 · Цель (в ряд): 5</div>
              </div>
              <button class="exitBtn" id="btnExit" type="button">× Выйти</button>
            </div>

            <div class="goalRow">
              <select id="selGoalInGame" class="goalSelect"></select>
              <div class="statusPill" id="statusPill">● Идёт игра</div>
            </div>

            <div class="controlRow">
              <button class="ctrlBtn" id="btnUndo" type="button">↩ Отменить</button>
              <button class="ctrlBtn" id="btnRestart" type="button">⟲ Заново</button>
              <button class="ctrlBtn" id="btnMenu" type="button">≡ Меню</button>
            </div>
          </div>

          <div class="boardCard">
            <div class="board" id="board"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTitle" id="modalTitle">Подтвердить</div>
      <div class="modalText" id="modalText">Текст</div>
      <div class="modalBtns">
        <button class="btn btnPlain" id="modalCancel" type="button">Отмена</button>
        <button class="btn btnSave" id="modalOk" type="button">Ок</button>
      </div>
    </div>
  </div>

<script>
  const BUILD = "2025.12.22.4"; // <- меняй число при каждом апдейте (для Telegram)

  // принудительный query v=BUILD (чтобы обновления чаще подтягивались)
  (function(){
    try{
      const u = new URL(location.href);
      const v = u.searchParams.get("v");
      if(v !== BUILD){
        if(sessionStorage.getItem("forcedV") !== BUILD){
          sessionStorage.setItem("forcedV", BUILD);
          u.searchParams.set("v", BUILD);
          location.replace(u.toString());
        }
      }
    }catch(e){}
  })();

  const I18N = {
    ru: {
      home:"Главная", settings:"Настройки", start:"Начать игру", save:"Сохранить",
      hint:"Сохрани — и нажми “Начать игру”",
      lang:"Язык", theme:"Тема", mode:"Режим", size:"Размер поля", goal:"Цель (в ряд)", ai:"Сложность ИИ",
      p1:"Игрок 1 (X)", p2:"Игрок 2 (O)", p3:"Игрок 3 (△)", p4:"Игрок 4 (□)",
      modePVP:"Игрок vs Игрок", modeAI:"Игрок vs ИИ", mode3:"3 игрока", mode4:"4 игрока",
      exit:"× Выйти", undo:"↩ Отменить", restart:"⟲ Заново", menu:"≡ Меню",
      turn:(n,s)=>`Ходит: ${n} (${s})`,
      sub:(sz,g)=>`${sz}×${sz} · Цель (в ряд): ${g}`,
      play:"● Идёт игра", win:"★ Победа", draw:"■ Ничья",
      confirmNew:"Это начнёт новую игру. Продолжить?",
      confirmExit:"Выйти в меню? Партия будет потеряна.",
      confirmGoal:"Менять цель во время партии нельзя без перезапуска. Начать новую игру с новой целью?",
      ok:"Ок", cancel:"Отмена",
      goalShort:"Цель:"
    },
    en: {
      home:"Home", settings:"Settings", start:"Start game", save:"Save",
      hint:"Save — then press “Start game”",
      lang:"Language", theme:"Theme", mode:"Mode", size:"Board size", goal:"Goal (in a row)", ai:"AI difficulty",
      p1:"Player 1 (X)", p2:"Player 2 (O)", p3:"Player 3 (△)", p4:"Player 4 (□)",
      modePVP:"Player vs Player", modeAI:"Player vs AI", mode3:"3 players", mode4:"4 players",
      exit:"× Exit", undo:"↩ Undo", restart:"⟲ Restart", menu:"≡ Menu",
      turn:(n,s)=>`Turn: ${n} (${s})`,
      sub:(sz,g)=>`${sz}×${sz} · Goal: ${g}`,
      play:"● Playing", win:"★ Win", draw:"■ Draw",
      confirmNew:"This will start a new game. Continue?",
      confirmExit:"Exit to menu? Current match will be lost.",
      confirmGoal:"Changing goal requires restart. Start a new game with the new goal?",
      ok:"OK", cancel:"Cancel",
      goalShort:"Goal:"
    },
    uz: {
      home:"Bosh sahifa", settings:"Sozlamalar", start:"O‘yinni boshlash", save:"Saqlash",
      hint:"Saqlang — so‘ng “O‘yinni boshlash” ni bosing",
      lang:"Til", theme:"Mavzu", mode:"Rejim", size:"Maydon o‘lchami", goal:"Maqsad (qator bo‘ylab)", ai:"AI qiyinligi",
      p1:"1-o‘yinchi (X)", p2:"2-o‘yinchi (O)", p3:"3-o‘yinchi (△)", p4:"4-o‘yinchi (□)",
      modePVP:"O‘yinchi vs O‘yinchi", modeAI:"O‘yinchi vs AI", mode3:"3 o‘yinchi", mode4:"4 o‘yinchi",
      exit:"× Chiqish", undo:"↩ Bekor qilish", restart:"⟲ Qayta", menu:"≡ Menyu",
      turn:(n,s)=>`Navbat: ${n} (${s})`,
      sub:(sz,g)=>`${sz}×${sz} · Maqsad: ${g}`,
      play:"● O‘yin ketmoqda", win:"★ G‘alaba", draw:"■ Durang",
      confirmNew:"Bu yangi o‘yinni boshlaydi. Davom etamizmi?",
      confirmExit:"Menyuga chiqilsinmi? Joriy o‘yin yo‘qoladi.",
      confirmGoal:"Maqsadni o‘zgartirish uchun qayta boshlash kerak. Yangi maqsad bilan yangi o‘yin boshlandi.",
      ok:"OK", cancel:"Bekor",
      goalShort:"Maqsad:"
    }
  };

  const MODES = [
    {id:"pvp", key:"modePVP", players:2, ai:false},
    {id:"ai",  key:"modeAI",  players:2, ai:true},
    {id:"p3",  key:"mode3",   players:3, ai:false},
    {id:"p4",  key:"mode4",   players:4, ai:false}
  ];
  const SYMBOLS = ["X","O","△","□"];

  const storeKey = "ttt_settings_v4";
  const gameKey  = "ttt_game_v4";

  const $ = id => document.getElementById(id);

  const screenHome = $("screenHome");
  const screenSettings = $("screenSettings");
  const screenGame = $("screenGame");

  const homeKicker = $("homeKicker");
  const homeMeta = $("homeMeta");
  const btnStart = $("btnStart");
  const btnStartText = $("btnStartText");

  const tabHome = $("tabHome");
  const tabSettings = $("tabSettings");
  const tabHome2 = $("tabHome2");
  const tabSettings2 = $("tabSettings2");
  const tabHomeText = $("tabHomeText");
  const tabSettingsText = $("tabSettingsText");
  const tabHomeText2 = $("tabHomeText2");
  const tabSettingsText2 = $("tabSettingsText2");

  const settingsTitle = $("settingsTitle");
  const settingsHint = $("settingsHint");
  const lblLang = $("lblLang");
  const lblTheme = $("lblTheme");
  const lblMode = $("lblMode");
  const lblSize = $("lblSize");
  const lblGoal = $("lblGoal");
  const lblAI = $("lblAI");
  const lblP1 = $("lblP1");
  const lblP2 = $("lblP2");
  const lblP3 = $("lblP3");
  const lblP4 = $("lblP4");

  const selLang = $("selLang");
  const selTheme = $("selTheme");
  const modeChips = $("modeChips");
  const selSize = $("selSize");
  const selGoal = $("selGoal");
  const aiRow = $("aiRow");
  const selAI = $("selAI");
  const inpP1 = $("inpP1");
  const inpP2 = $("inpP2");
  const inpP3 = $("inpP3");
  const inpP4 = $("inpP4");
  const nameGrid34 = $("nameGrid34");

  const btnSave = $("btnSave");
  const btnSaveText = $("btnSaveText");
  const buildText = $("buildText");

  const turnTitle = $("turnTitle");
  const turnSub = $("turnSub");
  const btnExit = $("btnExit");
  const selGoalInGame = $("selGoalInGame");
  const statusPill = $("statusPill");
  const btnUndo = $("btnUndo");
  const btnRestart = $("btnRestart");
  const btnMenu = $("btnMenu");
  const boardEl = $("board");

  const modalBack = $("modalBack");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalCancel = $("modalCancel");
  const modalOk = $("modalOk");
  let modalResolve = null;

  let settings = loadSettings();
  let board = [];
  let history = [];
  let lastMoveIdx = null;
  let winLine = [];
  let gameOver = false;

  function loadSettings(){
    try{
      const raw = localStorage.getItem(storeKey);
      if(raw){
        const s = JSON.parse(raw);
        return {
          lang: s.lang || "ru",
          theme: s.theme || "light",
          mode: s.mode || "pvp",
          size: clamp(s.size,3,10,8),
          goal: clamp(s.goal,3,10,5),
          ai: s.ai || "expert",
          p1: s.p1 || "Alex",
          p2: s.p2 || "Player 2",
          p3: s.p3 || "Player 3",
          p4: s.p4 || "Player 4"
        };
      }
    }catch(e){}
    return {lang:"ru",theme:"light",mode:"pvp",size:8,goal:5,ai:"expert",p1:"Alex",p2:"Player 2",p3:"Player 3",p4:"Player 4"};
  }
  function saveSettings(){ localStorage.setItem(storeKey, JSON.stringify(settings)); }

  function applyTheme(){
    document.documentElement.setAttribute("data-theme", settings.theme);
  }

  function getMode(){ return MODES.find(m=>m.id===settings.mode) || MODES[0]; }
  function playerName(i){
    if(i===0) return settings.p1 || "Player 1";
    if(i===1) return settings.mode==="ai" ? (settings.p2 || "Bot") : (settings.p2 || "Player 2");
    if(i===2) return settings.p3 || "Player 3";
    return settings.p4 || "Player 4";
  }
  function safeName(s){ return (s||"").trim().slice(0,16) || "Player"; }

  function clamp(v,min,max,fallback){
    const n = parseInt(v,10);
    if(Number.isFinite(n)) return Math.max(min, Math.min(max, n));
    return fallback;
  }

  function go(screen){
    screenHome.classList.toggle("hidden", screen!=="home");
    screenSettings.classList.toggle("hidden", screen!=="settings");
    screenGame.classList.toggle("hidden", screen!=="game");
  }

  function renderAllTexts(){
    const t = I18N[settings.lang];

    homeKicker.textContent = t.home;
    btnStartText.textContent = t.start;

    tabHomeText.textContent = t.home;
    tabSettingsText.textContent = t.settings;
    tabHomeText2.textContent = t.home;
    tabSettingsText2.textContent = t.settings;

    settingsTitle.textContent = t.settings;
    settingsHint.textContent = t.hint;
    lblLang.textContent = t.lang;
    lblTheme.textContent = t.theme;
    lblMode.textContent = t.mode;
    lblSize.textContent = t.size;
    lblGoal.textContent = t.goal;
    lblAI.textContent = t.ai;
    lblP1.textContent = t.p1;
    lblP2.textContent = t.p2;
    lblP3.textContent = t.p3;
    lblP4.textContent = t.p4;

    btnSaveText.textContent = t.save;
    buildText.textContent = `build ${BUILD}`;

    btnExit.textContent = t.exit;
    btnUndo.textContent = t.undo;
    btnRestart.textContent = t.restart;
    btnMenu.textContent = t.menu;

    renderHomeMeta();
    renderGameHeader();
    rebuildGoalInGameOptions();
  }

  function renderHomeMeta(){
    const t = I18N[settings.lang];
    const modeName = t[getMode().key];
    const names = (() => {
      const m = getMode();
      const arr = [];
      arr.push(`${safeName(playerName(0))} (${SYMBOLS[0]})`);
      arr.push(`${safeName(playerName(1))} (${SYMBOLS[1]})`);
      if(m.players>=3) arr.push(`${safeName(playerName(2))} (${SYMBOLS[2]})`);
      if(m.players>=4) arr.push(`${safeName(playerName(3))} (${SYMBOLS[3]})`);
      return arr.join(", ");
    })();
    homeMeta.textContent = `${modeName} · ${settings.size}×${settings.size} · ${t.goal}: ${settings.goal} ${names}`;
  }

  function applySettingsToForm(){
    selLang.value = settings.lang;
    selTheme.value = settings.theme;
    selAI.value = settings.ai;

    // sizes 3..10
    selSize.innerHTML = "";
    for(let s=3; s<=10; s++){
      const o = document.createElement("option");
      o.value = String(s);
      o.textContent = `${s}×${s}`;
      selSize.appendChild(o);
    }
    selSize.value = String(settings.size);

    // mode chips
    modeChips.innerHTML = "";
    const t = I18N[settings.lang];
    MODES.forEach(m=>{
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip" + (m.id===settings.mode ? " chipOn":"");
      chip.textContent = t[m.key];
      chip.addEventListener("click", ()=>{
        settings.mode = m.id;
        // bot name default
        if(settings.mode==="ai" && (!inpP2.value.trim())) inpP2.value = "Bot";
        saveSettings();
        applySettingsToForm();
        renderAllTexts();
      });
      modeChips.appendChild(chip);
    });

    // goal options 3..size
    settings.goal = clamp(settings.goal, 3, settings.size, Math.min(5, settings.size));
    selGoal.innerHTML = "";
    for(let g=3; g<=settings.size; g++){
      const o = document.createElement("option");
      o.value = String(g);
      o.textContent = String(g);
      selGoal.appendChild(o);
    }
    selGoal.value = String(settings.goal);

    // AI visible only in ai mode
    aiRow.style.display = (settings.mode==="ai") ? "grid" : "none";

    // names
    inpP1.value = settings.p1;
    inpP2.value = settings.p2;
    inpP3.value = settings.p3;
    inpP4.value = settings.p4;

    nameGrid34.style.display = (settings.mode==="p3" || settings.mode==="p4") ? "grid" : "none";
    inpP2.placeholder = (settings.mode==="ai") ? "Bot" : "Player 2";
  }

  function rebuildGoalInGameOptions(){
    const t = I18N[settings.lang];
    selGoalInGame.innerHTML = "";
    for(let g=3; g<=settings.size; g++){
      const o = document.createElement("option");
      o.value = String(g);
      o.textContent = `${t.goalShort} ${g}`;
      selGoalInGame.appendChild(o);
    }
    selGoalInGame.value = String(settings.goal);
  }

  function renderGameHeader(){
    const t = I18N[settings.lang];
    if(!board.length) return;

    if(gameOver){
      const res = checkWin(board, settings.size, settings.goal);
      if(res.win){
        const winner = SYMBOLS.indexOf(res.sym);
        turnTitle.textContent = t.turn(safeName(playerName(winner)), res.sym);
        statusPill.textContent = t.win;
      }else{
        turnTitle.textContent = t.draw;
        statusPill.textContent = t.draw;
      }
    }else{
      const p = history.length % getMode().players;
      turnTitle.textContent = t.turn(safeName(playerName(p)), SYMBOLS[p]);
      statusPill.textContent = t.play;
    }

    turnSub.textContent = t.sub(settings.size, settings.goal);
    btnUndo.disabled = history.length === 0;
  }

  function startNewGame(){
    board = new Array(settings.size * settings.size).fill("");
    history = [];
    lastMoveIdx = null;
    winLine = [];
    gameOver = false;

    localStorage.setItem(gameKey, JSON.stringify({
      version: BUILD,
      settingsSnapshot: {...settings},
      board, history, lastMoveIdx, winLine, gameOver
    }));

    rebuildGoalInGameOptions();
    renderGameHeader();
    renderBoard();
    go("game");
  }

  function loadGame(){
    try{
      const raw = localStorage.getItem(gameKey);
      if(!raw) return null;
      const g = JSON.parse(raw);
      if(g.version !== BUILD) return null;
      if(g.settingsSnapshot) settings = {...settings, ...g.settingsSnapshot};
      board = g.board || [];
      history = g.history || [];
      lastMoveIdx = g.lastMoveIdx ?? null;
      winLine = g.winLine || [];
      gameOver = !!g.gameOver;
      return g;
    }catch(e){ return null; }
  }

  function saveGame(){
    localStorage.setItem(gameKey, JSON.stringify({
      version: BUILD,
      settingsSnapshot: {...settings},
      board, history, lastMoveIdx, winLine, gameOver
    }));
  }

  function clearGame(){
    localStorage.removeItem(gameKey);
  }

  function renderBoard(){
    boardEl.style.gridTemplateColumns = `repeat(${settings.size}, 1fr)`;
    boardEl.innerHTML = "";

    for(let i=0;i<board.length;i++){
      const cell = document.createElement("button");
      cell.type = "button";
      cell.className = "cell";
      cell.textContent = board[i];

      if(lastMoveIdx === i) cell.classList.add("cellLast");
      if(winLine.includes(i)) cell.classList.add("cellWin");

      const disabled = gameOver || !!board[i];
      if(disabled) cell.classList.add("cellDisabled");

      cell.addEventListener("click", ()=>{
        if(disabled) return;
        makeMove(i);
      });

      boardEl.appendChild(cell);
    }
  }

  function makeMove(idx){
    if(gameOver) return;
    if(board[idx]) return;

    const mode = getMode();
    const p = history.length % mode.players;
    board[idx] = SYMBOLS[p];
    history.push({idx, player:p});
    lastMoveIdx = idx;

    const res = checkWin(board, settings.size, settings.goal);
    if(res.win){
      gameOver = true;
      winLine = res.line;
    }else if(history.length === board.length){
      gameOver = true;
      winLine = [];
    }else{
      winLine = [];
    }

    saveGame();
    renderGameHeader();
    renderBoard();

    if(!gameOver && mode.ai){
      const nextP = history.length % mode.players;
      if(nextP === 1){
        setTimeout(botMove, 90);
      }
    }
  }

  function botMove(){
    if(gameOver) return;
    const empties = [];
    for(let i=0;i<board.length;i++) if(!board[i]) empties.push(i);
    if(!empties.length) return;

    const size = settings.size, goal = settings.goal;
    const bot = "O", me = "X";

    // win
    for(const idx of empties){
      board[idx]=bot;
      const r = checkWin(board,size,goal);
      board[idx]="";
      if(r.win){ makeMove(idx); return; }
    }
    // block
    for(const idx of empties){
      board[idx]=me;
      const r = checkWin(board,size,goal);
      board[idx]="";
      if(r.win){ makeMove(idx); return; }
    }
    // simple heuristic: center preference
    let best = empties[0], bestScore = -1e9;
    const center = (size-1)/2;
    for(const idx of empties){
      const r = Math.floor(idx/size), c = idx%size;
      let sc = -(Math.abs(r-center)+Math.abs(c-center));
      if(sc>bestScore){ bestScore=sc; best=idx; }
    }
    makeMove(best);
  }

  function doUndo(){
    if(!history.length) return;

    const mode = getMode();
    // if game ended — reopen
    if(gameOver){ gameOver=false; winLine=[]; }

    const popOne = ()=>{
      const last = history.pop();
      if(!last) return;
      board[last.idx] = "";
      lastMoveIdx = history.length ? history[history.length-1].idx : null;
    };

    popOne();
    if(mode.ai){
      // remove bot move too if exists
      if(history.length && history[history.length-1].player === 1) popOne();
    }

    // recompute win
    const res = checkWin(board, settings.size, settings.goal);
    if(res.win){ gameOver=true; winLine=res.line; }
    else { gameOver=false; winLine=[]; }

    saveGame();
    renderGameHeader();
    renderBoard();
  }

  function checkWin(b,size,goal){
    const dirs=[[1,0],[0,1],[1,1],[1,-1]];
    for(let r=0;r<size;r++){
      for(let c=0;c<size;c++){
        const start = b[r*size+c];
        if(!start) continue;
        for(const [dr,dc] of dirs){
          const endR = r + dr*(goal-1);
          const endC = c + dc*(goal-1);
          if(endR<0||endR>=size||endC<0||endC>=size) continue;

          let ok=true;
          const line=[];
          for(let k=0;k<goal;k++){
            const rr=r+dr*k, cc=c+dc*k;
            const v=b[rr*size+cc];
            if(v!==start){ ok=false; break; }
            line.push(rr*size+cc);
          }
          if(ok) return {win:true, sym:start, line};
        }
      }
    }
    return {win:false, sym:"", line:[]};
  }

  function modalConfirm(text, title){
    const t = I18N[settings.lang];
    modalTitle.textContent = title || "";
    modalText.textContent = text || "";
    modalCancel.textContent = t.cancel;
    modalOk.textContent = t.ok;
    modalBack.classList.add("on");
    return new Promise(res=>modalResolve=res);
  }
  function closeModal(ok){
    modalBack.classList.remove("on");
    if(modalResolve){ modalResolve(!!ok); modalResolve=null; }
  }

  // EVENTS
  tabHome.addEventListener("click", ()=>{ go("home"); });
  tabHome2.addEventListener("click", ()=>{ go("home"); });

  tabSettings.addEventListener("click", ()=>{ go("settings"); });
  tabSettings2.addEventListener("click", ()=>{ go("settings"); });

  btnStart.addEventListener("click", ()=> startNewGame());

  btnSave.addEventListener("click", ()=>{
    settings.lang = selLang.value;
    settings.theme = selTheme.value;
    settings.size = clamp(selSize.value,3,10,8);
    settings.goal = clamp(selGoal.value,3,settings.size, Math.min(5, settings.size));
    settings.ai = selAI.value;

    settings.p1 = safeName(inpP1.value || "Alex");
    settings.p2 = safeName(inpP2.value || (settings.mode==="ai" ? "Bot" : "Player 2"));
    settings.p3 = safeName(inpP3.value || "Player 3");
    settings.p4 = safeName(inpP4.value || "Player 4");

    saveSettings();
    applyTheme();
    applySettingsToForm();
    renderAllTexts();
  });

  selLang.addEventListener("change", ()=>{
    settings.lang = selLang.value;
    saveSettings();
    applySettingsToForm();
    renderAllTexts();
  });

  selTheme.addEventListener("change", ()=>{
    settings.theme = selTheme.value;
    saveSettings();
    applyTheme();
    renderAllTexts();
  });

  selSize.addEventListener("change", ()=>{
    settings.size = clamp(selSize.value,3,10,8);
    settings.goal = clamp(settings.goal,3,settings.size, Math.min(5, settings.size));
    saveSettings();
    applySettingsToForm();
    renderAllTexts();
  });

  selGoal.addEventListener("change", ()=>{
    settings.goal = clamp(selGoal.value,3,settings.size, Math.min(5, settings.size));
    saveSettings();
    rebuildGoalInGameOptions();
    renderAllTexts();
  });

  selGoalInGame.addEventListener("change", async ()=>{
    const newGoal = clamp(selGoalInGame.value,3,settings.size,settings.goal);
    if(newGoal === settings.goal) return;

    const t = I18N[settings.lang];
    if(history.length === 0){
      settings.goal = newGoal;
      saveSettings();
      rebuildGoalInGameOptions();
      renderAllTexts();
      return;
    }
    const ok = await modalConfirm(t.confirmGoal, t.goal);
    if(ok){
      settings.goal = newGoal;
      saveSettings();
      startNewGame();
    }else{
      selGoalInGame.value = String(settings.goal);
    }
  });

  btnExit.addEventListener("click", async ()=>{
    const t = I18N[settings.lang];
    const ok = await modalConfirm(t.confirmExit, t.exit);
    if(ok){
      clearGame();
      go("home");
    }
  });

  btnMenu.addEventListener("click", async ()=>{
    const t = I18N[settings.lang];
    const ok = await modalConfirm(t.confirmExit, t.menu);
    if(ok){
      clearGame();
      go("home");
    }
  });

  btnRestart.addEventListener("click", async ()=>{
    const t = I18N[settings.lang];
    const ok = await modalConfirm(t.confirmNew, t.restart);
    if(ok) startNewGame();
  });

  btnUndo.addEventListener("click", ()=> doUndo());

  modalCancel.addEventListener("click", ()=> closeModal(false));
  modalOk.addEventListener("click", ()=> closeModal(true));
  modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(false); });

  // INIT
  applyTheme();
  applySettingsToForm();
  renderAllTexts();

  const g = loadGame();
  if(g && board.length){
    rebuildGoalInGameOptions();
    renderGameHeader();
    renderBoard();
    go("game");
  }else{
    go("home");
  }
</script>
</body>
</html>
