<!doctype html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic Tac Toe</title>
  <style>
    :root{
      --accent:#2fd0cf;
      --accent2:#22bdbd;

      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6eaf0;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.10);
      --shadow2: 0 6px 18px rgba(15, 23, 42, 0.08);

      --btn:#ffffff;
      --btnText:#0f172a;

      --cell:#ffffff;
      --cellLine:#dfe6ee;

      --radius:22px;
      --radius2:18px;
      --radius3:14px;
    }

    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:#101b2e;
      --text:#e7eefc;
      --muted:#9fb0cf;
      --line:#1c2b46;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --btn:#0f1a2c;
      --btnText:#e7eefc;

      --cell:#0f1a2c;
      --cellLine:#1d2c4a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:18px 12px 88px;
    }
    .app{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Header */
    .header{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      border-radius: 28px;
      padding:18px 16px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .header::after{
      content:"";
      position:absolute;
      inset:-40px -60px auto auto;
      width:180px;height:180px;
      background: rgba(255,255,255,.18);
      border-radius:999px;
      transform: rotate(20deg);
    }
    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:2;
    }
    .avatar{
      width:42px;height:42px;
      border-radius:999px;
      background: rgba(255,255,255,.24);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      color: rgba(255,255,255,.95);
      letter-spacing:.2px;
    }
    .topIcons{display:flex;gap:8px}
    .iconBtn{
      width:42px;height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.16);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .05s ease;
    }
    .iconBtn:active{transform: translateY(1px)}

    /* NEW: Home content inside header */
    .headerCard{
      margin-top:14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      padding:14px;
      box-shadow: var(--shadow2);
      position:relative;
      z-index:2;
    }
    html[data-theme="dark"] .headerCard{
      background: rgba(16,27,46,.88);
      border-color: rgba(255,255,255,.06);
    }
    .hcTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .hcTitle{
      font-weight:1000;
      font-size:14px;
      color: var(--text);
    }
    .hcMuted{
      margin-top:6px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .hcActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    /* Cards */
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-weight:900;
      font-size:14px;
    }
    .muted{color: var(--muted); font-size:13px; line-height:1.35}

    /* Inputs */
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:420px){.row2{grid-template-columns:1fr}}
    label{font-size:12px;color: var(--muted);display:block;margin-bottom:6px}
    input, select, button{
      font:inherit;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--btnText);
      padding:12px 12px;
      outline:none;
    }
    select, input{width:100%}
    button{cursor:pointer;transition: transform .05s ease; font-weight:900;}
    button:active{transform: translateY(1px)}
    .primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:#fff;
      border-color: rgba(255,255,255,.0);
      font-weight:1000;
    }
    .ghost{background: transparent}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--btnText);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      font-size:13px;
    }
    .chip.active{
      border-color: color-mix(in srgb, var(--accent2) 60%, var(--line));
      box-shadow: 0 6px 16px rgba(34,189,189,.18);
    }

    /* Game */
    .gameTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .turnLine{font-weight:900;font-size:14px}
    .turnLine span{color: var(--accent2)}
    .miniBar{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:10px 12px;
      border-radius: 999px;
      background: var(--btn);
      border:1px solid var(--line);
      color: var(--btnText);
      font-weight:800;
      font-size:13px;
    }

    .boardWrap{
      margin-top:12px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }

    .boardWrap::before{
      content:"";
      position:absolute;
      inset:0;
      opacity: .28;
      pointer-events:none;
      background: var(--map-bg);
      filter: saturate(1.05);
    }
    html[data-theme="dark"] .boardWrap::before{opacity:.22}

    .board{
      position:relative;
      z-index:1;
      display:grid;
      gap:8px;
      user-select:none;
      touch-action: manipulation;
    }
    .cell{
      aspect-ratio:1/1;
      border-radius: var(--radius3);
      border:1px solid var(--cellLine);
      background: color-mix(in srgb, var(--cell) 94%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      cursor:pointer;
      font-size: clamp(18px, 7.2vw, 40px);
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      backdrop-filter: blur(2px);
    }
    .cell:active{transform: scale(.985)}
    .cell.win{
      border-color: rgba(34,197,94,.75);
      box-shadow: inset 0 0 0 2px rgba(34,197,94,.18);
    }
    .cell.disabled{cursor:not-allowed;opacity:.88}

    /* Bottom Nav (ONLY 2 items) */
    .bottomNav{
      position:fixed;left:0;right:0;bottom:10px;
      display:flex;justify-content:center;
      pointer-events:none;z-index:50;
    }
    .navBar{
      width:min(520px, calc(100% - 24px));
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      padding:8px 10px;
      box-shadow: var(--shadow);
      display:flex;
      justify-content:space-between;
      gap:8px;
      pointer-events:auto;
    }
    .navItem{
      flex:1;
      border-radius: 18px;
      padding:10px 10px;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:4px;
      cursor:pointer;
      color: var(--muted);
      font-size:12px;
      border:1px solid transparent;
      user-select:none;
    }
    .navItem b{font-size:14px;color: var(--muted)}
    .navItem.active{
      color: var(--text);
      border-color: color-mix(in srgb, var(--accent2) 25%, var(--line));
      background: color-mix(in srgb, var(--accent2) 10%, transparent);
    }
    .navItem.active b{color: var(--accent2)}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:80;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-weight:900;
    }
    .modalBody{color:var(--muted); font-size:13px; line-height:1.35}
    .modalFoot{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:92px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      border-radius: 999px;
      padding:10px 12px;
      font-size:13px;
      display:none;
      z-index:90;
      max-width:min(520px, calc(100% - 24px));
    }
    .toast.show{display:block}
    html[data-theme="dark"] .toast{background: rgba(0,0,0,.72)}
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER (NOW CONTAINS "HOME" CONTENT) -->
    <div class="header" id="header">
      <div class="topRow">
        <div class="avatar">TT</div>
        <div class="topIcons">
          <button class="iconBtn" id="btnLang" title="Language">üåê</button>
          <button class="iconBtn" id="btnTheme" title="Theme">üåì</button>
        </div>
      </div>

      <!-- moved summary+buttons here -->
      <div class="headerCard" id="homeCardInHeader">
        <div class="hcTop">
          <div>
            <div class="hcTitle" data-i18n="home_title">–ì–ª–∞–≤–Ω–∞—è</div>
            <div class="hcMuted" id="homeSummary"></div>
          </div>
          <button class="ghost" id="btnRules" data-i18n="rules_btn">–ü—Ä–∞–≤–∏–ª–∞</button>
        </div>

        <div class="hcActions">
          <button class="primary" id="btnStart" data-i18n="start_game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <button id="btnContinue" style="display:none;" data-i18n="continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS ONLY -->
    <div id="viewSettings" class="card" style="display:none;">
      <div class="cardTitle">
        <span data-i18n="settings_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        <span class="muted" id="settingsHint"></span>
      </div>

      <div class="row2">
        <div>
          <label data-i18n="language">–Ø–∑—ã–∫</label>
          <select id="selLang">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="uz">O‚Äòzbek (lotin)</option>
          </select>
        </div>
        <div>
          <label data-i18n="theme">–¢–µ–º–∞</label>
          <select id="selTheme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div>
        <label data-i18n="mode">–†–µ–∂–∏–º</label>
        <div class="chips" id="modeChips"></div>
      </div>

      <div style="height:10px"></div>

      <div class="row2">
        <div>
          <label data-i18n="size">–†–∞–∑–º–µ—Ä –ø–æ–ª—è</label>
          <select id="selSize"></select>
        </div>
        <div>
          <label data-i18n="goal">–¶–µ–ª—å (–≤ —Ä—è–¥)</label>
          <select id="selGoal"></select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row2" id="aiRow">
        <div>
          <label data-i18n="ai_diff">–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò</label>
          <select id="selAi">
            <option value="easy" data-i18n="ai_easy">–õ—ë–≥–∫–∏–π</option>
            <option value="med" data-i18n="ai_med">–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="hard" data-i18n="ai_hard">–°–ª–æ–∂–Ω—ã–π</option>
            <option value="exp" data-i18n="ai_exp">–≠–∫—Å–ø–µ—Ä—Ç</option>
          </select>
        </div>
        <div></div>
      </div>

      <div style="height:10px"></div>

      <div id="namesBlock" class="row2"></div>

      <div style="margin-top:12px;">
        <button class="primary" id="btnSaveSettings" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="viewGame" style="display:none;">
      <div class="card">
        <div class="gameTop">
          <div>
            <div class="turnLine" id="turnLine">‚Äî</div>
            <div class="muted" id="miniInfo">‚Äî</div>
          </div>

          <div class="miniBar">
            <select id="inGameGoal" class="mini" title="Goal"></select>
            <button class="mini" id="btnUndo" data-i18n="undo">Undo</button>
            <button class="mini" id="btnRestart" data-i18n="restart">Restart</button>
            <button class="mini" id="btnMenu" data-i18n="menu">–ú–µ–Ω—é</button>
          </div>
        </div>
      </div>

      <div class="boardWrap" id="boardWrap" style="--map-bg: radial-gradient(circle at 20% 20%, rgba(47,208,207,.35), transparent 50%), radial-gradient(circle at 70% 70%, rgba(34,189,189,.25), transparent 55%);">
        <div class="board" id="board"></div>
      </div>
    </div>

  </div>

  <!-- Bottom Nav: ONLY HOME + SETTINGS -->
  <div class="bottomNav">
    <div class="navBar">
      <div class="navItem active" id="navHome"><b>‚åÇ</b><span data-i18n="nav_home">–ì–ª–∞–≤–Ω–∞—è</span></div>
      <div class="navItem" id="navSettings"><b>‚öô</b><span data-i18n="nav_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>
  </div>

  <!-- RULES MODAL -->
  <div class="overlay" id="overlayRules">
    <div class="modal">
      <div class="modalHead">
        <span data-i18n="rules_title">–ü—Ä–∞–≤–∏–ª–∞</span>
        <button class="ghost" id="closeRules" data-i18n="close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody" id="rulesBody"></div>
      <div class="modalFoot">
        <button class="primary" id="okRules" data-i18n="ok">–û–∫</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   i18n RU/EN/UZ (lotin)
   ========================= */
const i18n = {
  ru: {
    home_title:"–ì–ª–∞–≤–Ω–∞—è",
    rules_btn:"–ü—Ä–∞–≤–∏–ª–∞",
    start_game:"–ù–∞—á–∞—Ç—å –∏–≥—Ä—É",
    continue:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
    settings_title:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    language:"–Ø–∑—ã–∫",
    theme:"–¢–µ–º–∞",
    mode:"–†–µ–∂–∏–º",
    size:"–†–∞–∑–º–µ—Ä –ø–æ–ª—è",
    goal:"–¶–µ–ª—å (–≤ —Ä—è–¥)",
    ai_diff:"–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò",
    ai_easy:"–õ—ë–≥–∫–∏–π",
    ai_med:"–°—Ä–µ–¥–Ω–∏–π",
    ai_hard:"–°–ª–æ–∂–Ω—ã–π",
    ai_exp:"–≠–∫—Å–ø–µ—Ä—Ç",
    save:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",

    undo:"Undo",
    restart:"Restart",
    menu:"–ú–µ–Ω—é",
    nav_home:"–ì–ª–∞–≤–Ω–∞—è",
    nav_settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",

    rules_title:"–ü—Ä–∞–≤–∏–ª–∞",
    close:"–ó–∞–∫—Ä—ã—Ç—å",
    ok:"–û–∫",

    mode_pvp:"–ò–≥—Ä–æ–∫ vs –ò–≥—Ä–æ–∫",
    mode_ai:"–ò–≥—Ä–æ–∫ vs –ò–ò",
    mode_3p:"3 –∏–≥—Ä–æ–∫–∞",
    mode_4p:"4 –∏–≥—Ä–æ–∫–∞",

    p1:"–ò–≥—Ä–æ–∫ 1",
    p2:"–ò–≥—Ä–æ–∫ 2",
    p3:"–ò–≥—Ä–æ–∫ 3",
    p4:"–ò–≥—Ä–æ–∫ 4",
    bot:"–ë–æ—Ç",

    turn:"–•–æ–¥–∏—Ç",
    win:"–ü–æ–±–µ–¥–∏–ª",
    draw:"–ù–∏—á—å—è",
    saved:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
    restored:"–ü—Ä–æ–¥–æ–ª–∂–∏–ª–∏ –∏–≥—Ä—É",
    goal_changed:"–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
  },
  en: {
    home_title:"Home",
    rules_btn:"Rules",
    start_game:"Start Game",
    continue:"Continue",
    settings_title:"Settings",
    language:"Language",
    theme:"Theme",
    mode:"Mode",
    size:"Board size",
    goal:"Target (in row)",
    ai_diff:"AI difficulty",
    ai_easy:"Easy",
    ai_med:"Medium",
    ai_hard:"Hard",
    ai_exp:"Expert",
    save:"Save",

    undo:"Undo",
    restart:"Restart",
    menu:"Menu",
    nav_home:"Home",
    nav_settings:"Settings",

    rules_title:"Rules",
    close:"Close",
    ok:"OK",

    mode_pvp:"Player vs Player",
    mode_ai:"Player vs AI",
    mode_3p:"3 Players",
    mode_4p:"4 Players",

    p1:"Player 1",
    p2:"Player 2",
    p3:"Player 3",
    p4:"Player 4",
    bot:"Bot",

    turn:"Turn",
    win:"Winner",
    draw:"Draw",
    saved:"Saved",
    restored:"Game restored",
    goal_changed:"Target updated"
  },
  uz: {
    home_title:"Bosh sahifa",
    rules_btn:"Qoidalar",
    start_game:"O‚Äòyinni boshlash",
    continue:"Davom ettirish",
    settings_title:"Sozlamalar",
    language:"Til",
    theme:"Mavzu",
    mode:"Rejim",
    size:"Maydon o‚Äòlchami",
    goal:"Maqsad (qator)",
    ai_diff:"AI darajasi",
    ai_easy:"Oson",
    ai_med:"O‚Äòrtacha",
    ai_hard:"Qiyin",
    ai_exp:"Ekspert",
    save:"Saqlash",

    undo:"Ortga (Undo)",
    restart:"Qayta",
    menu:"Menyu",
    nav_home:"Bosh sahifa",
    nav_settings:"Sozlamalar",

    rules_title:"Qoidalar",
    close:"Yopish",
    ok:"OK",

    mode_pvp:"O‚Äòyinchi vs O‚Äòyinchi",
    mode_ai:"O‚Äòyinchi vs AI",
    mode_3p:"3 o‚Äòyinchi",
    mode_4p:"4 o‚Äòyinchi",

    p1:"1-o‚Äòyinchi",
    p2:"2-o‚Äòyinchi",
    p3:"3-o‚Äòyinchi",
    p4:"4-o‚Äòyinchi",
    bot:"Bot",

    turn:"Navbat",
    win:"G‚Äòolib",
    draw:"Durrang",
    saved:"Saqlandi",
    restored:"O‚Äòyin tiklandi",
    goal_changed:"Maqsad yangilandi"
  }
};

const LS_PREF="ttt_bank_prefs_v3";
const LS_SAVE="ttt_bank_save_v3";

const defaultPrefs = {
  lang:"ru",
  theme:"light",
  mode:"pvp",
  size:5,
  goal:3,
  ai:"easy",
  names:{p1:"Alex", p2:"Player 2", p3:"Player 3", p4:"Player 4"}
};

const mapSkins = [
  { css:`radial-gradient(circle at 18% 22%, rgba(47,208,207,.35), transparent 52%),
         radial-gradient(circle at 70% 38%, rgba(34,189,189,.22), transparent 58%),
         radial-gradient(circle at 42% 78%, rgba(47,208,207,.18), transparent 55%),
         linear-gradient(180deg, rgba(15,23,42,.04), transparent 60%)`},
  { css:`repeating-radial-gradient(circle at 35% 45%, rgba(34,189,189,.18) 0 10px, transparent 10px 18px),
         radial-gradient(circle at 75% 25%, rgba(47,208,207,.22), transparent 55%),
         linear-gradient(180deg, rgba(15,23,42,.03), transparent 70%)`},
  { css:`repeating-linear-gradient(135deg, rgba(34,189,189,.14) 0 10px, transparent 10px 22px),
         radial-gradient(circle at 30% 30%, rgba(47,208,207,.20), transparent 55%),
         radial-gradient(circle at 80% 75%, rgba(34,189,189,.14), transparent 58%)`},
  { css:`radial-gradient(circle at 25% 35%, rgba(47,208,207,.20), transparent 55%),
         radial-gradient(circle at 60% 65%, rgba(34,189,189,.18), transparent 60%),
         repeating-linear-gradient(0deg, rgba(15,23,42,.03) 0 6px, transparent 6px 14px)`},
  { css:`repeating-linear-gradient(90deg, rgba(47,208,207,.12) 0 8px, transparent 8px 18px),
         repeating-linear-gradient(180deg, rgba(34,189,189,.10) 0 10px, transparent 10px 22px)`},
];

const state = {
  prefs: load(LS_PREF, defaultPrefs),
  view:"home", // home | settings | game
  N:5,
  K:3,
  players:[],
  turn:0,
  board:[],
  history:[],
  winLine:[],
  winner:null,
  locked:false,
  mapSkin: mapSkins[0].css
};

function load(k, fallback){
  try{ return Object.assign({}, fallback, JSON.parse(localStorage.getItem(k)||"{}")); }
  catch{ return JSON.parse(JSON.stringify(fallback)); }
}
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function t(key){ return (i18n[state.prefs.lang] && i18n[state.prefs.lang][key]) || i18n.ru[key] || key; }

function toast(msg, ms=1400){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.classList.remove("show"), ms);
}

function setTheme(theme){
  state.prefs.theme = theme;
  document.documentElement.dataset.theme = theme;
  save(LS_PREF, state.prefs);
}
function setLang(lang){
  state.prefs.lang = lang;
  save(LS_PREF, state.prefs);
  applyI18n();
  renderAll();
}

function clampGoal(goal, size){
  return Math.max(3, Math.min(Number(goal)||3, size));
}

const viewSettings = document.getElementById("viewSettings");
const viewGame = document.getElementById("viewGame");

function setView(v){
  state.view=v;
  viewSettings.style.display = (v==="settings")?"":"none";
  viewGame.style.display = (v==="game")?"":"none";
  setNavActive(v);
}
function setNavActive(v){
  document.getElementById("navHome").classList.toggle("active", v==="home" || v==="game");
  document.getElementById("navSettings").classList.toggle("active", v==="settings");
}

function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.textContent = t(el.dataset.i18n);
  });
}

function modeLabel(){
  switch(state.prefs.mode){
    case "pvp": return t("mode_pvp");
    case "ai":  return t("mode_ai");
    case "3p":  return t("mode_3p");
    case "4p":  return t("mode_4p");
    default: return t("mode_pvp");
  }
}

function renderHome(){
  const p = state.prefs;
  const N = p.size;
  const K = clampGoal(p.goal, N);

  let playersText="";
  if(p.mode==="ai"){
    playersText = `${escapeHtml(p.names.p1)} (X), ${t("bot")} (O)`;
  }else if(p.mode==="3p"){
    playersText = `${escapeHtml(p.names.p1)} (X), ${escapeHtml(p.names.p2)} (O), ${escapeHtml(p.names.p3)} (‚ñ≥)`;
  }else if(p.mode==="4p"){
    playersText = `${escapeHtml(p.names.p1)} (X), ${escapeHtml(p.names.p2)} (O), ${escapeHtml(p.names.p3)} (‚ñ≥), ${escapeHtml(p.names.p4)} (‚ñ°)`;
  }else{
    playersText = `${escapeHtml(p.names.p1)} (X), ${escapeHtml(p.names.p2)} (O)`;
  }

  // compact summary (no "–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å", no big title block, no play button)
  document.getElementById("homeSummary").innerHTML =
    `<div class="hcMuted"><b>${modeLabel()}</b> ¬∑ ${N}√ó${N} ¬∑ ${t("goal")}: ${K}</div>
     <div class="hcMuted" style="margin-top:6px;">${playersText}</div>`;

  document.getElementById("btnContinue").style.display =
    localStorage.getItem(LS_SAVE) ? "" : "none";
}

function renderSettings(){
  const p = state.prefs;

  document.getElementById("selLang").value = p.lang;
  document.getElementById("selTheme").value = p.theme;

  const chips=document.getElementById("modeChips");
  chips.innerHTML="";
  const modes=[
    {k:"pvp", label:t("mode_pvp")},
    {k:"ai",  label:t("mode_ai")},
    {k:"3p",  label:t("mode_3p")},
    {k:"4p",  label:t("mode_4p")},
  ];
  for(const m of modes){
    const d=document.createElement("div");
    d.className="chip"+(p.mode===m.k?" active":"");
    d.textContent=m.label;
    d.onclick=()=>{
      p.mode=m.k;
      save(LS_PREF,p);
      renderSettings();
      renderHome();
    };
    chips.appendChild(d);
  }

  const selSize=document.getElementById("selSize");
  selSize.innerHTML="";
  for(let n=3;n<=10;n++){
    const o=document.createElement("option");
    o.value=String(n);
    o.textContent=`${n}√ó${n}`;
    if(p.size===n) o.selected=true;
    selSize.appendChild(o);
  }

  const selGoal=document.getElementById("selGoal");
  selGoal.innerHTML="";
  const size=Number(p.size);
  p.goal = clampGoal(p.goal, size);
  for(let k=3;k<=size;k++){
    const o=document.createElement("option");
    o.value=String(k);
    o.textContent=String(k);
    if(p.goal===k) o.selected=true;
    selGoal.appendChild(o);
  }

  document.getElementById("aiRow").style.display = (p.mode==="ai") ? "" : "none";
  document.getElementById("selAi").value = p.ai;

  const nb=document.getElementById("namesBlock");
  nb.innerHTML="";

  const makeInput=(key, labelTxt)=>{
    const wrap=document.createElement("div");
    const lab=document.createElement("label");
    lab.textContent=labelTxt;
    const inp=document.createElement("input");
    inp.maxLength=16;
    inp.value = p.names[key] || "";
    inp.oninput=(e)=>{ p.names[key]=e.target.value; save(LS_PREF,p); renderHome(); };
    wrap.appendChild(lab); wrap.appendChild(inp);
    nb.appendChild(wrap);
  };

  makeInput("p1", `${t("p1")} (X)`);

  if(p.mode==="ai"){
    const wrap=document.createElement("div");
    const lab=document.createElement("label");
    lab.textContent=`${t("p2")} (O)`;
    const inp=document.createElement("input");
    inp.value = t("bot");
    inp.disabled=true;
    wrap.appendChild(lab); wrap.appendChild(inp);
    nb.appendChild(wrap);
  }else{
    makeInput("p2", `${t("p2")} (O)`);
  }

  if(p.mode==="3p" || p.mode==="4p") makeInput("p3", `${t("p3")} (‚ñ≥)`);
  if(p.mode==="4p") makeInput("p4", `${t("p4")} (‚ñ°)`);

  document.getElementById("settingsHint").textContent = `${size}√ó${size} ¬∑ ${t("goal")}: ${p.goal}`;
}

/* Game */
function symbolsForMode(mode){
  if(mode==="4p") return ["X","O","‚ñ≥","‚ñ°"];
  if(mode==="3p") return ["X","O","‚ñ≥"];
  return ["X","O"];
}
function setupPlayers(){
  const p=state.prefs;
  state.N = Number(p.size);
  state.K = clampGoal(p.goal, state.N);

  const syms = symbolsForMode(p.mode);
  const names = p.names;

  if(p.mode==="ai"){
    state.players = [
      {sym:"X", name: names.p1 || "P1"},
      {sym:"O", name: t("bot")}
    ];
  }else{
    const arr=[];
    arr.push({sym:syms[0], name: names.p1 || "P1"});
    arr.push({sym:syms[1], name: names.p2 || "P2"});
    if(syms[2]) arr.push({sym:syms[2], name: names.p3 || "P3"});
    if(syms[3]) arr.push({sym:syms[3], name: names.p4 || "P4"});
    state.players = arr;
  }
}
function pickRandomMap(){
  const idx = Math.floor(Math.random()*mapSkins.length);
  state.mapSkin = mapSkins[idx].css;
  document.getElementById("boardWrap").style.setProperty("--map-bg", state.mapSkin);
}
function buildBoard(){
  const boardEl = document.getElementById("board");
  boardEl.innerHTML="";
  boardEl.style.gridTemplateColumns = `repeat(${state.N}, 1fr)`;
  boardEl.style.gap = (state.N>=9) ? "6px" : "8px";

  for(let i=0;i<state.N*state.N;i++){
    const btn=document.createElement("div");
    btn.className="cell";
    btn.dataset.i = i;
    btn.onclick=()=>play(i);
    boardEl.appendChild(btn);
  }
}
function populateInGameGoal(){
  const sel=document.getElementById("inGameGoal");
  sel.innerHTML="";
  for(let k=3;k<=state.N;k++){
    const o=document.createElement("option");
    o.value=String(k);
    o.textContent=`${t("goal")}: ${k}`;
    if(k===state.K) o.selected=true;
    sel.appendChild(o);
  }
  sel.onchange=(e)=>{
    const newK = clampGoal(e.target.value, state.N);
    state.K = newK;
    state.prefs.goal = newK;
    save(LS_PREF, state.prefs);
    state.winner=null;
    state.winLine=[];
    const res = checkWinner();
    if(res){ finish(res); }
    renderHome();
    renderGameUI();
    toast(t("goal_changed"));
    saveGameState();
  };
}

function startGame(){
  setupPlayers();
  state.board = Array(state.N*state.N).fill(null);
  state.history = [];
  state.winLine = [];
  state.winner = null;
  state.locked = false;
  state.turn = 0;

  pickRandomMap();
  buildBoard();
  populateInGameGoal();
  renderGameUI();

  setView("game");
  saveGameState();
  toast(t("saved"));

  if(state.prefs.mode==="ai" && currentSym()==="O"){
    state.locked=true;
    setTimeout(botMove, 220);
  }
}
function continueGame(){
  const saved = JSON.parse(localStorage.getItem(LS_SAVE)||"null");
  if(!saved) return;

  state.prefs = saved.prefs || state.prefs;
  setTheme(state.prefs.theme);
  setLang(state.prefs.lang);

  state.N = saved.N || 5;
  state.K = clampGoal(saved.K || state.prefs.goal || 3, state.N);
  state.players = saved.players || [];
  state.turn = saved.turn || 0;
  state.board = saved.board || Array(state.N*state.N).fill(null);
  state.history = saved.history || [];
  state.winLine = [];
  state.winner = null;
  state.locked = false;

  state.mapSkin = saved.mapSkin || mapSkins[0].css;
  document.getElementById("boardWrap").style.setProperty("--map-bg", state.mapSkin);

  buildBoard();
  populateInGameGoal();
  renderBoard();
  renderGameUI();
  setView("game");
  toast(t("restored"));
}

function currentPlayer(){ return state.players[state.turn]; }
function currentSym(){ return currentPlayer().sym; }

function play(i){
  if(state.locked || state.winner) return;
  if(state.board[i]) return;
  if(state.prefs.mode==="ai" && currentSym()==="O") return;

  applyMove(i, currentSym());
  const res = checkWinner();
  if(res){ finish(res); return; }

  nextTurn();
  renderGameUI();
  saveGameState();

  if(state.prefs.mode==="ai" && currentSym()==="O"){
    state.locked=true;
    setTimeout(botMove, 160);
  }
}
function applyMove(i, sym){
  state.board[i]=sym;
  state.history.push({i, sym, turnBefore: state.turn});
  const cell = document.querySelector(`.cell[data-i="${i}"]`);
  if(cell) cell.textContent = sym;
}
function nextTurn(){
  state.turn = (state.turn+1) % state.players.length;
}
function renderBoard(){
  document.querySelectorAll(".cell").forEach(el=>{
    const idx = Number(el.dataset.i);
    el.textContent = state.board[idx] || "";
    el.classList.toggle("disabled", !!state.board[idx] || state.locked || !!state.winner);
    el.classList.remove("win");
  });
  state.winLine.forEach(idx=>{
    const el=document.querySelector(`.cell[data-i="${idx}"]`);
    if(el) el.classList.add("win");
  });
}
function renderGameUI(){
  renderBoard();
  const p = currentPlayer();
  document.getElementById("turnLine").innerHTML = `${t("turn")}: <span>${escapeHtml(p.name)}</span> (${p.sym})`;
  document.getElementById("miniInfo").textContent = `${state.N}√ó${state.N} ¬∑ ${t("goal")}: ${state.K}`;
}

function checkWinner(){
  const N=state.N, K=state.K, B=state.board;
  const seqs=[];

  for(let r=0;r<N;r++){
    for(let c=0;c<=N-K;c++){
      const s=[];
      for(let t=0;t<K;t++) s.push(r*N+(c+t));
      seqs.push(s);
    }
  }
  for(let c=0;c<N;c++){
    for(let r=0;r<=N-K;r++){
      const s=[];
      for(let t=0;t<K;t++) s.push((r+t)*N+c);
      seqs.push(s);
    }
  }
  for(let r=0;r<=N-K;r++){
    for(let c=0;c<=N-K;c++){
      const s=[];
      for(let t=0;t<K;t++) s.push((r+t)*N+(c+t));
      seqs.push(s);
    }
  }
  for(let r=K-1;r<N;r++){
    for(let c=0;c<=N-K;c++){
      const s=[];
      for(let t=0;t<K;t++) s.push((r-t)*N+(c+t));
      seqs.push(s);
    }
  }

  for(const s of seqs){
    const a=B[s[0]];
    if(!a) continue;
    let ok=true;
    for(let i=1;i<s.length;i++) if(B[s[i]]!==a){ ok=false; break; }
    if(ok){
      state.winLine=s;
      state.winner=a;
      return {winner:a, line:s};
    }
  }
  if(B.every(Boolean)){
    state.winner="D";
    state.winLine=[];
    return {winner:"D", line:[]};
  }
  return null;
}

function finish(res){
  state.locked=false;
  renderBoard();
  localStorage.removeItem(LS_SAVE);

  if(res.winner==="D"){
    toast(t("draw"));
  }else{
    const name = state.players.find(p=>p.sym===res.winner)?.name || res.winner;
    toast(`${t("win")}: ${name}`);
  }
}
function undo(){
  if(state.winner) return;
  if(!state.history.length) return;

  const pops = (state.prefs.mode==="ai") ? 2 : 1;
  for(let k=0;k<pops;k++){
    const last = state.history.pop();
    if(!last) break;
    state.board[last.i]=null;
    state.turn = last.turnBefore;
  }
  state.winLine=[];
  state.winner=null;
  state.locked=false;
  renderGameUI();
  saveGameState();
}
function restart(){ startGame(); }

function saveGameState(){
  save(LS_SAVE,{
    prefs: state.prefs,
    N: state.N, K: state.K,
    players: state.players,
    turn: state.turn,
    board: state.board,
    history: state.history,
    mapSkin: state.mapSkin
  });
}

/* Simple AI */
function botMove(){
  if(state.winner) { state.locked=false; return; }

  const empties=[];
  for(let i=0;i<state.board.length;i++) if(!state.board[i]) empties.push(i);

  const win = findImmediate("O", empties);
  if(win!=null){ state.locked=false; applyMove(win,"O"); afterBot(); return; }
  const block = findImmediate("X", empties);
  if(block!=null){ state.locked=false; applyMove(block,"O"); afterBot(); return; }

  const pick = pickHeuristic(empties);
  state.locked=false;
  applyMove(pick,"O");
  afterBot();
}
function afterBot(){
  const res=checkWinner();
  if(res){ finish(res); return; }
  nextTurn();
  renderGameUI();
  saveGameState();
}
function findImmediate(sym, empties){
  for(const i of empties){
    state.board[i]=sym;
    const r=checkWinner();
    state.board[i]=null;
    state.winLine=[]; state.winner=null;
    if(r && r.winner===sym) return i;
  }
  return null;
}
function pickHeuristic(empties){
  const N=state.N;
  const center = Math.floor(N/2)*N + Math.floor(N/2);
  if(empties.includes(center)) return center;

  const hasNear = (idx)=>{
    const r=Math.floor(idx/N), c=idx%N;
    for(let dr=-1;dr<=1;dr++){
      for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const rr=r+dr, cc=c+dc;
        if(rr>=0 && cc>=0 && rr<N && cc<N){
          const j=rr*N+cc;
          if(state.board[j]) return true;
        }
      }
    }
    return false;
  };
  const near = empties.filter(hasNear);
  const pool = near.length ? near : empties;

  const ai = state.prefs.ai;
  if(ai==="easy") return pool[Math.floor(Math.random()*pool.length)];
  if(ai==="med") return pool[Math.floor(Math.random()*Math.min(pool.length, Math.max(3, Math.floor(pool.length/2))))];

  let best = pool[0], bestD=Infinity;
  const cr=Math.floor(N/2), cc=Math.floor(N/2);
  for(const idx of pool){
    const r=Math.floor(idx/N), c=idx%N;
    const d = Math.abs(r-cr)+Math.abs(c-cc);
    if(d<bestD){ bestD=d; best=idx; }
  }
  return best;
}

/* Rules */
function openRules(){
  const p=state.prefs;
  const N=p.size;
  const K=clampGoal(p.goal, N);
  const mode=modeLabel();
  const html = `
    <b>${mode}</b><br/><br/>
    <b>${t("goal")}:</b> ${K}<br/>
    <b>${t("size")}:</b> ${N}√ó${N}<br/><br/>
    ‚Ä¢ X / O (–∏ ‚ñ≥ / ‚ñ° –≤ —Ä–µ–∂–∏–º–∞—Ö 3‚Äì4 –∏–≥—Ä–æ–∫–∞) —Ö–æ–¥—è—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏.<br/>
    ‚Ä¢ –ü–æ–±–µ–¥–∞: <b>${K}</b> —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ä—è–¥ (–≥–æ—Ä/–≤–µ—Ä—Ç/–¥–∏–∞–≥).<br/>
    ‚Ä¢ –í –∏–≥—Ä–µ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ü–µ–ª—å (–≤ —Ä—è–¥) —Å–≤–µ—Ä—Ö—É.<br/>
    ‚Ä¢ Undo: –æ—Ç–∫–∞—Ç —Ö–æ–¥–∞ (vs AI ‚Äî 2 —Ö–æ–¥–∞).<br/>
    ‚Ä¢ –ù–∏—á—å—è: –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç.
  `;
  document.getElementById("rulesBody").innerHTML = html;
  document.getElementById("overlayRules").classList.add("show");
}
function closeRules(){ document.getElementById("overlayRules").classList.remove("show"); }

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function renderAll(){
  applyI18n();
  renderHome();
  renderSettings();
}

/* Wiring */
function wire(){
  document.documentElement.dataset.theme = state.prefs.theme;

  state.prefs.goal = clampGoal(state.prefs.goal, state.prefs.size);
  save(LS_PREF, state.prefs);

  renderAll();
  setView("home");

  document.getElementById("btnLang").onclick=()=>{ setView("settings"); };
  document.getElementById("btnTheme").onclick=()=>{
    setTheme(state.prefs.theme==="light" ? "dark" : "light");
    renderAll();
  };

  document.getElementById("btnRules").onclick=openRules;
  document.getElementById("btnStart").onclick=startGame;
  document.getElementById("btnContinue").onclick=continueGame;

  document.getElementById("selLang").onchange=(e)=>setLang(e.target.value);
  document.getElementById("selTheme").onchange=(e)=>{ setTheme(e.target.value); renderAll(); };

  document.getElementById("selSize").onchange=(e)=>{
    state.prefs.size = Number(e.target.value);
    state.prefs.goal = clampGoal(state.prefs.goal, state.prefs.size);
    save(LS_PREF, state.prefs);
    renderAll();
  };
  document.getElementById("selGoal").onchange=(e)=>{
    state.prefs.goal = clampGoal(e.target.value, state.prefs.size);
    save(LS_PREF, state.prefs);
    renderHome();
    renderSettings();
  };
  document.getElementById("selAi").onchange=(e)=>{
    state.prefs.ai = e.target.value;
    save(LS_PREF, state.prefs);
  };

  document.getElementById("btnSaveSettings").onclick=()=>{
    save(LS_PREF, state.prefs);
    renderAll();
    toast(t("saved"));
    setView("home");
  };

  document.getElementById("btnUndo").onclick=undo;
  document.getElementById("btnRestart").onclick=restart;
  document.getElementById("btnMenu").onclick=()=>{ setView("home"); renderHome(); };

  document.getElementById("closeRules").onclick=closeRules;
  document.getElementById("okRules").onclick=closeRules;

  document.getElementById("navHome").onclick=()=>{ setView("home"); };
  document.getElementById("navSettings").onclick=()=>{ setView("settings"); };

  document.addEventListener("keydown",(e)=>{
    if(state.view!=="game") return;
    if(state.N===3 && e.key>="1" && e.key<="9") play(Number(e.key)-1);
    if(e.key.toLowerCase()==="u") undo();
    if(e.key.toLowerCase()==="r") restart();
  });
}
wire();
</script>
</body>
</html>
