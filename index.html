<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Tic-Tac-Toe Liquid</title>

  <style>
    :root{
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);

      /* Жидкие цвета iOS 26 */
      --accent-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
      --accent-glow: rgba(0, 114, 255, 0.4);
      
      --bg-grad: radial-gradient(circle at 50% 10%, rgba(0, 198, 255, 0.15) 0%, rgba(0,0,0,0) 60%),
                 radial-gradient(circle at 90% 60%, rgba(0, 114, 255, 0.12) 0%, rgba(0,0,0,0) 50%),
                 linear-gradient(180deg, #F2F4F8 0%, #E3E9F2 100%);

      --text: #1d1d1f;
      --text-sec: rgba(29, 29, 31, 0.6);
      
      /* Glassmorphism 3.0 */
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.8);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      --blur: blur(24px);

      --btn-bg: rgba(255, 255, 255, 0.7);
      --btn-text: #1d1d1f;
      
      --r-card: 28px;
      
      /* Цвета фигур */
      --symX: #007AFF;
      --symO: #FF9500;
      --symT: #AF52DE;
      --symS: #30B0C7;

      /* Анимации */
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    [data-theme="dark"]{
      --bg-grad: radial-gradient(circle at 50% 10%, rgba(10, 132, 255, 0.2) 0%, rgba(0,0,0,0) 60%),
                 radial-gradient(circle at 90% 60%, rgba(94, 92, 230, 0.15) 0%, rgba(0,0,0,0) 50%),
                 linear-gradient(180deg, #000000 0%, #121212 100%);

      --text: #f5f5f7;
      --text-sec: rgba(245, 245, 247, 0.6);

      --glass-bg: rgba(30, 30, 30, 0.6);
      --glass-border: rgba(255, 255, 255, 0.12);
      --glass-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);

      --btn-bg: rgba(255, 255, 255, 0.1);
      --btn-text: #ffffff;
      
      --symX: #0A84FF;
      --symO: #FF9F0A;
      --symT: #BF5AF2;
      --symS: #64D2FF;
    }

    /* KEYFRAMES */
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(15px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.5); }
      50% { transform: scale(1.15); }
      100% { opacity: 1; transform: scale(1); }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg-grad);
      background-attachment: fixed;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    button, .chip, .tab, .cell{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app{
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--safeTop) + 20px) 16px calc(var(--safeBottom) + 20px);
    }

    .stage{
      width:min(440px, 100%);
      display:flex;
      flex-direction:column;
      gap:20px;
      position:relative;
      z-index: 1;
    }

    /* --- LIQUID CARDS --- */
    .glass-panel{
      width:100%;
      border-radius: var(--r-card);
      background: var(--glass-bg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      padding: 24px;
      position:relative;
      /* Анимация появления */
      animation: fadeSlideUp 0.5s var(--ease-smooth) backwards;
    }
    
    /* --- HERO --- */
    .hero{
      text-align: center;
      padding: 32px 24px;
    }
    
    .heroTitle{
      margin: 0;
      font-size: 38px;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: var(--accent-grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 12px var(--accent-glow));
    }
    
    .heroMeta{
      margin-top: 12px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-sec);
    }
    
    /* --- BUTTONS --- */
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 99px;
      padding: 16px 32px;
      font-size: 17px;
      font-weight: 600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      transition: all 0.25s var(--ease-spring);
      position: relative;
    }
    .btn:active{ transform: scale(0.92); }
    
    .btnPrimary{
      background: var(--accent-grad);
      color: white;
      box-shadow: 0 10px 20px var(--accent-glow);
    }
    .btnPrimary:hover{
      box-shadow: 0 14px 28px var(--accent-glow);
      transform: translateY(-2px);
    }
    .btnPrimary:active{
      transform: scale(0.96) translateY(0);
    }

    .btnSec{
      background: var(--btn-bg);
      color: var(--btn-text);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* --- TABBAR --- */
    .tabbar-wrap{
      display: flex;
      justify-content: center;
      margin-top: 10px;
      animation: fadeSlideUp 0.6s var(--ease-smooth) 0.1s backwards;
    }
    .tabbar{
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 99px;
      padding: 6px;
      display:flex;
      gap: 4px;
      box-shadow: var(--glass-shadow);
      border: 1px solid var(--glass-border);
    }
    .tab{
      border:none;
      background: transparent;
      padding: 10px 20px;
      border-radius: 99px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .tab.tabOn{
      background: var(--text);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    [data-theme="dark"] .tab.tabOn{ background: #fff; color: #000; }

    /* --- FORMS --- */
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    
    .field{ margin-bottom: 16px; }
    .label{ font-size: 13px; font-weight: 600; color: var(--text-sec); margin-bottom: 8px; margin-left: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    input, select{
      width:100%;
      padding: 14px 16px;
      border-radius: 16px;
      border: none;
      background: rgba(120, 120, 128, 0.12);
      color: var(--text);
      font-size: 17px;
      font-family: inherit;
      outline: none;
      transition: background 0.2s;
      -webkit-appearance: none;
    }
    input:focus, select:focus{ background: rgba(120, 120, 128, 0.18); }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      padding: 10px 18px;
      border-radius: 99px;
      background: rgba(120, 120, 128, 0.12);
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chip.chipOn{
      background: transparent;
      border-color: #007AFF;
      color: #007AFF;
    }
    [data-theme="dark"] .chip.chipOn{ border-color: #0A84FF; color: #0A84FF; }

    /* --- GAME BOARD --- */
    .gameTop{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .turnTitle{ font-size: 22px; font-weight: 700; }
    .status{ font-size: 14px; font-weight: 600; color: var(--text-sec); }
    
    .board-frame{
      aspect-ratio: 1/1;
      width: 100%;
      background: rgba(120, 120, 128, 0.08);
      border-radius: 24px;
      padding: 8px;
    }
    .board{
      width: 100%;
      height: 100%;
      display: grid;
    }
    
    .cell{
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 4px 8px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.15s var(--ease-spring);
      
      min-width: 0;
      min-height: 0;
      overflow: hidden; 
      line-height: 1;
      font-size: var(--cell-fs);
    }
    [data-theme="dark"] .cell{ border-color: rgba(255,255,255,0.08); }
    
    .cell:active{ transform: scale(0.85); }
    .cell.cellDisabled{ cursor: default; transform: none; opacity: 1; }
    .cell.cellWin{
      background: var(--accent-glow);
      border-color: var(--symX);
      transform: scale(1.02); /* Легкое увеличение победных клеток */
    }

    .sym{ 
      font-weight: 800; 
      display:block; 
      /* Анимация появления символа */
      animation: popIn 0.4s var(--ease-spring) backwards;
    }
    .symX{ color: var(--symX); filter: drop-shadow(0 2px 8px rgba(0,122,255,0.3)); }
    .symO{ color: var(--symO); filter: drop-shadow(0 2px 8px rgba(255,149,0,0.3)); }

    /* --- MODAL --- */
    .modalBack{
      position:fixed; inset:0; z-index:100;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      display:none; align-items:center; justify-content:center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modalBack.on{ display:flex; opacity: 1; }
    
    .modal{
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      width: min(320px, 80%);
      padding: 24px;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      transform: scale(0.9); transition: transform 0.3s var(--ease-spring);
    }
    .modalBack.on .modal{ transform: scale(1); }
    
    .modalTitle{ font-size: 19px; font-weight: 700; margin-bottom: 8px; }
    .modalText{ font-size: 15px; color: var(--text-sec); margin-bottom: 20px; }
    
    .modalBtns{ display: flex; gap: 12px; }
    .btnModal{ flex: 1; padding: 12px; border-radius: 14px; font-weight: 600; border: none; cursor: pointer; font-size: 15px;}
    .btnCancel{ background: rgba(120, 120, 128, 0.12); color: var(--text); }
    .btnOk{ background: var(--accent-grad); color: white; }

    .hidden{ display: none !important; }
    .center-col{ display: flex; flex-direction: column; align-items: center; width: 100%; }

    .toast{
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: rgba(255,255,255,0.9); color: black;
      padding: 12px 24px; border-radius: 99px; font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 200; opacity: 0; transition: all 0.4s var(--ease-spring);
    }
    [data-theme="dark"] .toast{ background: rgba(40,40,40,0.9); color: white; }
    .toast.on{ opacity: 1; transform: translateX(-50%) translateY(0); }

  </style>
</head>

<body>

  <div class="app">
    <div class="stage">
    
      <div id="screenHome" class="center-col">
        <div class="glass-panel hero">
          <div class="heroTitle">Tic-Tac-Toe</div>
          <div id="subtitle" style="font-size:18px; font-weight:300; opacity:0.7; margin-top:4px;">Liquid Edition</div>
          <div class="heroMeta" id="homeMeta">...</div>
          
          <div style="margin-top: 32px;">
            <button id="btnStart" class="btn btnPrimary" type="button">
              ▶ Начать игру
            </button>
          </div>
        </div>

        <div class="tabbar-wrap">
          <div class="tabbar">
            <button id="tabHome" class="tab tabOn">Главная</button>
            <button id="tabSettings" class="tab">Настройки</button>
          </div>
        </div>
      </div>

      <div id="screenSettings" class="center-col hidden">
        <div class="glass-panel">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-size:24px; font-weight:800;" id="settingsTitle">Настройки</div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label" id="lblLang">Язык</div>
              <select id="selLang">
                <option value="ru">Русский</option>
                <option value="en">English</option>
                <option value="uz">O‘zbek</option>
              </select>
            </div>
            <div class="field">
              <div class="label" id="lblTheme">Тема</div>
              <select id="selTheme"></select>
            </div>
          </div>

          <div class="field">
            <div class="label" id="lblMode">Режим игры</div>
            <div class="chips" id="modeChips"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <div class="label" id="lblSize">Поле</div>
              <select id="selSize"></select>
            </div>
            <div class="field">
              <div class="label" id="lblGoal">Цель (в ряд)</div>
              <select id="selGoal"></select>
            </div>
          </div>
          
          <div class="field" id="aiRow">
             <div class="label" id="lblAI">Сложность ИИ</div>
             <select id="selAI"></select>
          </div>

          <div style="margin-top:10px; border-top:1px solid rgba(120,120,128,0.1); padding-top:16px;">
            <div class="label" id="lblNames">Имена игроков</div>
            <div class="grid2">
               <input id="inpP1" maxlength="10" placeholder="Игрок 1" />
               <input id="inpP2" maxlength="10" placeholder="Игрок 2" />
            </div>
            <div class="grid2" id="nameGrid34" style="display:none; margin-top:12px;">
               <input id="inpP3" maxlength="10" placeholder="Игрок 3" />
               <input id="inpP4" maxlength="10" placeholder="Игрок 4" />
            </div>
          </div>

          <div style="margin-top: 24px;">
            <button id="btnSave" class="btn btnPrimary" style="width:100%">Сохранить настройки</button>
          </div>
        </div>
        
        <div class="tabbar-wrap">
          <div class="tabbar">
            <button id="tabHome2" class="tab">Главная</button>
            <button id="tabSettings2" class="tab tabOn">Настройки</button>
          </div>
        </div>
      </div>

      <div id="screenGame" class="center-col hidden">
        <div class="glass-panel">
          <div class="gameTop">
            <div>
              <div class="turnTitle" id="turnTitle">Ходит X</div>
              <div class="status" id="turnSub">...</div>
            </div>
            <button class="btn btnSec" id="btnExit" style="padding: 8px 16px; font-size:14px;">Выйти</button>
          </div>

          <div class="board-frame">
            <div class="board" id="board"></div>
          </div>

          <div style="display:flex; gap:12px; margin-top:20px;">
            <button class="btn btnSec" id="btnUndo" style="flex:1;">↩ Отмена</button>
            <button class="btn btnSec" id="btnRestart" style="flex:1;">⟲ Заново</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTitle" id="modalTitle">...</div>
      <div class="modalText" id="modalText">...</div>
      <div class="modalBtns">
        <button class="btnModal btnCancel" id="modalCancel">Отмена</button>
        <button class="btnModal btnOk" id="modalOk">ОК</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast">Сохранено</div>

<script>
  const BUILD = "2026.01.20.Liquid.Anim";

  const I18N = {
    ru: {
      home:"Главная", settings:"Настройки", start:"Начать игру", save:"Сохранить",
      applied:"Настройки применены",
      lang:"Язык", theme:"Тема", 
      themeLight:"Светлая", themeDark:"Тёмная",
      mode:"Режим", size:"Размер поля", goal:"Цель (в ряд)", ai:"Сложность ИИ",
      aiEasy:"Лёгкая (Ошибается)", aiNormal:"Нормальная", aiHard:"Сложная", aiExpert:"Непобедимый",
      p1:"Игрок 1", p2:"Игрок 2", p3:"Игрок 3", p4:"Игрок 4",
      playersLabel:"Имена игроков",
      modePVP:"1 vs 1", modeAI:"1 vs AI", mode3:"3 Игрока", mode4:"4 Игрока",
      exit:"Выйти", undo:"Отмена", restart:"Заново",
      turn:(n,s)=>`Ход: ${n}`,
      sub:(sz,g)=>`${sz}×${sz} • Цель: ${g}`,
      play:"Игра идёт", win:"Победа!", draw:"Ничья",
      confirmTitle: "Подтверждение",
      confirmExit:"Выйти в меню?", confirmNew:"Начать заново?",
      ok:"Да", cancel:"Нет"
    },
    en: {
      home:"Home", settings:"Settings", start:"Start", save:"Save",
      applied:"Applied",
      lang:"Language", theme:"Theme", 
      themeLight:"Light", themeDark:"Dark",
      mode:"Mode", size:"Size", goal:"Goal", ai:"AI Level",
      aiEasy:"Easy (Mistakes)", aiNormal:"Normal", aiHard:"Hard", aiExpert:"Unbeatable",
      p1:"Player 1", p2:"Player 2", p3:"Player 3", p4:"Player 4",
      playersLabel:"Player Names",
      modePVP:"1 vs 1", modeAI:"1 vs AI", mode3:"3 Players", mode4:"4 Players",
      exit:"Exit", undo:"Undo", restart:"Restart",
      turn:(n,s)=>`Turn: ${n}`,
      sub:(sz,g)=>`${sz}×${sz} • Goal: ${g}`,
      play:"Playing", win:"Winner!", draw:"Draw",
      confirmTitle: "Confirm",
      confirmExit:"Exit to menu?", confirmNew:"Restart game?",
      ok:"Yes", cancel:"No"
    },
    uz: {
      home:"Bosh sahifa", settings:"Sozlamalar", start:"Boshlash", save:"Saqlash",
      applied:"Saqlandi",
      lang:"Til", theme:"Mavzu", 
      themeLight:"Yorug‘", themeDark:"Qorong‘i",
      mode:"Rejim", size:"O‘lcham", goal:"Maqsad", ai:"AI Darajasi",
      aiEasy:"Oson (Xato qiladi)", aiNormal:"O‘rta", aiHard:"Qiyin", aiExpert:"Yengilmas",
      p1:"1-o‘yinchi", p2:"2-o‘yinchi", p3:"3-o‘yinchi", p4:"4-o‘yinchi",
      playersLabel:"O‘yinchilar",
      modePVP:"1 vs 1", modeAI:"1 vs AI", mode3:"3 Kishi", mode4:"4 Kishi",
      exit:"Chiqish", undo:"Bekor", restart:"Qayta",
      turn:(n,s)=>`Navbat: ${n}`,
      sub:(sz,g)=>`${sz}×${sz} • Maqsad: ${g}`,
      play:"O‘yin", win:"G‘alaba!", draw:"Durang",
      confirmTitle: "Tasdiqlash",
      confirmExit:"Chiqasizmi?", confirmNew:"Qayta boshlash?",
      ok:"Ha", cancel:"Yo‘q"
    }
  };

  const MODES = [
    {id:"pvp", key:"modePVP", players:2, ai:false},
    {id:"ai",  key:"modeAI",  players:2, ai:true},
    {id:"p3",  key:"mode3",   players:3, ai:false},
    {id:"p4",  key:"mode4",   players:4, ai:false}
  ];
  
  const AI_LEVELS = [
    {id:"easy", key:"aiEasy"},
    {id:"normal", key:"aiNormal"},
    {id:"hard", key:"aiHard"},
    {id:"expert", key:"aiExpert"}
  ];
  
  const THEMES = [
    {id:"light", key:"themeLight"},
    {id:"dark", key:"themeDark"}
  ];

  const SYMBOLS = ["X","O","△","□"];

  const storeKey = "ttt_settings_liquid";
  const gameKey  = "ttt_game_liquid";

  const $ = id => document.getElementById(id);
  const screenHome = $("screenHome");
  const screenSettings = $("screenSettings");
  const screenGame = $("screenGame");

  let settings = loadSettings();
  let board = [];
  let history = [];
  let gameOver = false;
  let winLine = [];

  function init(){
    applyTheme();
    renderUI();
    
    $("btnStart").onclick = startNewGame;
    $("tabHome").onclick = ()=>go("home");
    $("tabSettings").onclick = ()=>go("settings");
    $("tabHome2").onclick = ()=>go("home");
    $("tabSettings2").onclick = ()=>go("settings");
    
    $("btnSave").onclick = saveAndApply;
    
    $("selLang").onchange = ()=>{ 
       settings.lang = $("selLang").value; 
       renderUI(); 
       syncSettingsForm(); 
    };
    $("selTheme").onchange = ()=>{ settings.theme = $("selTheme").value; applyTheme(); };
    $("selSize").onchange = rebuildGoalSelect;
    
    $("btnExit").onclick = async ()=>{
      if(await modalConfirm(I18N[settings.lang].confirmExit)) {
        board=[]; gameOver=false; saveGame(); go("home");
      }
    };
    $("btnRestart").onclick = async ()=>{
       if(await modalConfirm(I18N[settings.lang].confirmNew)) startNewGame();
    };
    $("btnUndo").onclick = doUndo;
    
    const g = loadGame();
    if(g && g.board.length > 0 && !g.gameOver){
      board = g.board; history=g.history; gameOver=g.gameOver;
      settings = g.settingsSnapshot;
      renderGame();
      go("game");
    } else {
      go("home");
    }
  }

  function go(scr){
    screenHome.classList.add("hidden");
    screenSettings.classList.add("hidden");
    screenGame.classList.add("hidden");
    
    $("tabHome").classList.remove("tabOn");
    $("tabSettings").classList.remove("tabOn");
    $("tabHome2").classList.remove("tabOn");
    $("tabSettings2").classList.remove("tabOn");

    if(scr==="home"){
       screenHome.classList.remove("hidden");
       $("tabHome").classList.add("tabOn");
       $("tabHome2").classList.add("tabOn");
       renderHomeMeta();
    }
    if(scr==="settings"){
       screenSettings.classList.remove("hidden");
       $("tabSettings").classList.add("tabOn");
       $("tabSettings2").classList.add("tabOn");
       syncSettingsForm();
    }
    if(scr==="game"){
       screenGame.classList.remove("hidden");
    }
  }

  function renderHomeMeta(){
    const t = I18N[settings.lang];
    const m = MODES.find(x=>x.id===settings.mode);
    const modeTxt = t[m.key];
    $("homeMeta").textContent = `${modeTxt} • ${settings.size}x${settings.size}`;
  }

  function syncSettingsForm(){
    $("selLang").value = settings.lang;
    
    const t = I18N[settings.lang];

    const selTheme = $("selTheme");
    selTheme.innerHTML = "";
    THEMES.forEach(th => {
        const opt = document.createElement("option");
        opt.value = th.id;
        opt.textContent = t[th.key];
        selTheme.appendChild(opt);
    });
    selTheme.value = settings.theme;
    
    const chipsDiv = $("modeChips");
    chipsDiv.innerHTML = "";
    MODES.forEach(m => {
      const b = document.createElement("div");
      b.className = "chip" + (settings.mode===m.id ? " chipOn" : "");
      b.textContent = t[m.key];
      b.onclick = ()=>{ settings.mode=m.id; syncSettingsForm(); };
      chipsDiv.appendChild(b);
    });

    const selSize = $("selSize");
    if(selSize.options.length === 0) {
        for(let i=3; i<=10; i++) {
           const opt = document.createElement("option");
           opt.value=i; opt.textContent=`${i}x${i}`;
           selSize.appendChild(opt);
        }
    }
    selSize.value = settings.size;
    rebuildGoalSelect();
    
    const selAI = $("selAI");
    selAI.innerHTML = "";
    AI_LEVELS.forEach(lvl => {
        const opt = document.createElement("option");
        opt.value = lvl.id;
        opt.textContent = t[lvl.key];
        selAI.appendChild(opt);
    });
    selAI.value = settings.ai;

    $("aiRow").style.display = (settings.mode==="ai") ? "block" : "none";

    $("inpP1").value = settings.p1;
    $("inpP2").value = settings.p2;
    $("inpP3").value = settings.p3;
    $("inpP4").value = settings.p4;
    $("nameGrid34").style.display = (settings.mode==="p3" || settings.mode==="p4") ? "grid" : "none";
  }

  function rebuildGoalSelect(){
    const sz = parseInt($("selSize").value);
    const selGoal = $("selGoal");
    selGoal.innerHTML = "";
    
    for(let i=3; i<=sz; i++){
       const opt = document.createElement("option");
       opt.value=i; opt.textContent=i;
       selGoal.appendChild(opt);
    }
    
    if(settings.goal <= sz && settings.goal >= 3) selGoal.value = settings.goal;
    else selGoal.value = Math.min(sz, 5); 
  }

  function saveAndApply(){
    settings.lang = $("selLang").value;
    settings.theme = $("selTheme").value;
    
    const chips = $("modeChips").children;
    for(let i=0; i<chips.length; i++){
       if(chips[i].classList.contains("chipOn")) settings.mode = MODES[i].id;
    }

    settings.size = parseInt($("selSize").value);
    settings.goal = parseInt($("selGoal").value);
    settings.ai = $("selAI").value;
    
    settings.p1 = $("inpP1").value.trim() || "Player 1";
    settings.p2 = $("inpP2").value.trim() || "Player 2";
    settings.p3 = $("inpP3").value.trim() || "Player 3";
    settings.p4 = $("inpP4").value.trim() || "Player 4";

    saveSettings();
    renderUI();
    showToast(I18N[settings.lang].applied);
  }

  function startNewGame(){
    board = Array(settings.size*settings.size).fill("");
    history = [];
    gameOver = false;
    winLine = [];
    saveGame();
    renderGame();
    go("game");
  }

  function renderGame(){
    const t = I18N[settings.lang];
    const bEl = $("board");
    
    bEl.style.gridTemplateColumns = `repeat(${settings.size}, 1fr)`;
    bEl.style.gridTemplateRows = `repeat(${settings.size}, 1fr)`;
    
    const gap = settings.size > 6 ? 4 : 8;
    bEl.style.gap = gap + "px";

    const fs = Math.max(16, 54 - settings.size * 3.5);
    bEl.style.setProperty("--cell-fs", fs + "px");
    
    bEl.innerHTML = "";
    
    board.forEach((val, idx)=>{
      const c = document.createElement("div");
      c.className = "cell";
      if(val){
        const sp = document.createElement("span");
        sp.className = "sym sym"+val; 
        sp.textContent = val;
        c.appendChild(sp);
      }
      if(winLine.includes(idx)) c.classList.add("cellWin");
      if(gameOver || val) c.classList.add("cellDisabled");
      
      c.onclick = ()=>makeMove(idx);
      bEl.appendChild(c);
    });

    const curP = history.length % getPlayersCount();
    const pName = getPlayerName(curP);
    
    if(gameOver){
       if(winLine.length) $("turnTitle").textContent = t.win + " " + getPlayerName(SYMBOLS.indexOf(board[winLine[0]]));
       else $("turnTitle").textContent = t.draw;
    } else {
       $("turnTitle").textContent = t.turn(pName, SYMBOLS[curP]);
    }
    $("turnSub").textContent = t.sub(settings.size, settings.goal);
    
    $("btnUndo").disabled = (history.length === 0 || gameOver);
    $("btnUndo").style.opacity = $("btnUndo").disabled ? 0.5 : 1;
  }

  function makeMove(idx){
    if(gameOver || board[idx]) return;
    
    const pIdx = history.length % getPlayersCount();
    board[idx] = SYMBOLS[pIdx];
    history.push({idx, p:pIdx});
    
    checkWinCondition();
    saveGame();
    renderGame();
    
    if(!gameOver && settings.mode === "ai" && getPlayersCount()===2){
       if( (history.length % 2) === 1 ){
          setTimeout(botMove, 400);
       }
    }
  }

  function botMove(){
    if(gameOver) return;
    const empties = board.map((v,i)=>v===""?i:-1).filter(i=>i!==-1);
    if(!empties.length) return;

    let move = -1;
    let mistakeChance = 0;
    if(settings.ai==="easy") mistakeChance=0.7;
    if(settings.ai==="normal") mistakeChance=0.3;
    if(settings.ai==="hard") mistakeChance=0.1;

    if(Math.random() < mistakeChance){
       move = empties[Math.floor(Math.random()*empties.length)];
    } else {
       move = findBestMove(empties);
    }
    
    makeMove(move);
  }
  
  function findBestMove(empties){
    const me = SYMBOLS[1];
    const en = SYMBOLS[0];
    const sz=settings.size, gl=settings.goal;

    for(let i of empties){
      board[i]=me; 
      if(checkWinSimple(board, sz, gl)) { board[i]=""; return i; }
      board[i]="";
    }
    for(let i of empties){
      board[i]=en;
      if(checkWinSimple(board, sz, gl)) { board[i]=""; return i; }
      board[i]="";
    }
    const center = (sz-1)/2;
    empties.sort((a,b)=>{
       const ra = Math.floor(a/sz), ca = a%sz;
       const rb = Math.floor(b/sz), cb = b%sz;
       const da = Math.abs(ra-center)+Math.abs(ca-center);
       const db = Math.abs(rb-center)+Math.abs(cb-center);
       return da-db;
    });
    return empties[0];
  }

  function doUndo(){
    if(!history.length) return;
    const last = history.pop();
    board[last.idx] = "";
    
    if(settings.mode==="ai" && history.length>0){
       const last2 = history.pop();
       board[last2.idx] = "";
    }
    
    gameOver=false; winLine=[];
    saveGame();
    renderGame();
  }

  function checkWinCondition(){
    const res = checkWinFull(board, settings.size, settings.goal);
    if(res.win){
       gameOver=true; winLine=res.line;
    } else if(history.length === settings.size*settings.size){
       gameOver=true;
    }
  }

  function getPlayersCount(){
     return MODES.find(m=>m.id===settings.mode).players;
  }
  function getPlayerName(idx){
     if(idx===0) return settings.p1;
     if(idx===1) return settings.p2;
     if(idx===2) return settings.p3;
     if(idx===3) return settings.p4;
     return "Player";
  }

  function checkWinFull(b, sz, goal){
     const dirs = [[1,0], [0,1], [1,1], [1,-1]];
     for(let r=0; r<sz; r++){
       for(let c=0; c<sz; c++){
         const start = b[r*sz+c];
         if(!start) continue;
         for(let d of dirs){
           let line = [];
           for(let k=0; k<goal; k++){
             const nr = r + d[0]*k;
             const nc = c + d[1]*k;
             if(nr<0||nr>=sz||nc<0||nc>=sz) break;
             if(b[nr*sz+nc] === start) line.push(nr*sz+nc);
             else break;
           }
           if(line.length === goal) return {win:true, line:line};
         }
       }
     }
     return {win:false};
  }
  function checkWinSimple(b, sz, goal){ return checkWinFull(b,sz,goal).win; }

  function loadSettings(){
    try{
      const s = JSON.parse(localStorage.getItem(storeKey));
      if(s) return {...defaultSettings(), ...s};
    }catch(e){}
    return defaultSettings();
  }
  function defaultSettings(){
    return {lang:"ru", theme:"light", mode:"pvp", size:3, goal:3, ai:"expert", p1:"Игрок 1", p2:"Игрок 2", p3:"Игрок 3", p4:"Игрок 4"};
  }
  function saveSettings(){ localStorage.setItem(storeKey, JSON.stringify(settings)); }
  
  function loadGame(){
    try{ return JSON.parse(localStorage.getItem(gameKey)); }catch(e){ return null; }
  }
  function saveGame(){
    localStorage.setItem(gameKey, JSON.stringify({version:BUILD, settingsSnapshot:settings, board, history, gameOver}));
  }

  function renderUI(){
     const t = I18N[settings.lang];
     $("btnStart").innerHTML = "▶ " + t.start;
     $("tabHome").textContent = t.home;
     $("tabSettings").textContent = t.settings;
     $("tabHome2").textContent = t.home;
     $("tabSettings2").textContent = t.settings;
     $("settingsTitle").textContent = t.settings;
     $("lblLang").textContent = t.lang;
     $("lblTheme").textContent = t.theme;
     $("lblMode").textContent = t.mode;
     $("lblSize").textContent = t.size;
     $("lblGoal").textContent = t.goal;
     $("lblAI").textContent = t.ai;
     $("lblNames").textContent = t.playersLabel; 
     
     $("inpP1").placeholder = t.p1;
     $("inpP2").placeholder = t.p2;
     $("inpP3").placeholder = t.p3;
     $("inpP4").placeholder = t.p4;
     
     $("btnSave").textContent = t.save;
     
     renderHomeMeta();
  }
  
  function applyTheme(){
     document.documentElement.setAttribute("data-theme", settings.theme);
  }

  function showToast(msg){
     const t = $("toast");
     t.textContent = msg;
     t.classList.add("on");
     setTimeout(()=>t.classList.remove("on"), 2000);
  }

  function modalConfirm(txt){
     return new Promise(resolve=>{
        const t = I18N[settings.lang];
        $("modalTitle").textContent = t.confirmTitle; 
        $("modalText").textContent = txt;
        $("modalCancel").textContent = t.cancel;
        $("modalOk").textContent = t.ok;

        $("modalBack").classList.add("on");
        $("modalOk").onclick = ()=>{ $("modalBack").classList.remove("on"); resolve(true); };
        $("modalCancel").onclick = ()=>{ $("modalBack").classList.remove("on"); resolve(false); };
     });
  }

  init();

</script>
</body>
</html>
